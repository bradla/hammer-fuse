<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!-- git web interface version 1.6.4.2.253.g0b1fac.dirty, (C) 2005-2006, Kay Sievers <kay.sievers@vrfy.org>, Christian Gierke -->
<!-- git core binaries version 1.6.4 -->
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="generator" content="gitweb/1.6.4.2.253.g0b1fac.dirty git/1.6.4"/>
<meta name="robots" content="index, nofollow"/>
<title>gitweb.dragonflybsd.org Git - dragonfly.git/blob - lib/libstand/hammerread.c</title>
<base href="http://gitweb.dragonflybsd.org" />
<link rel="stylesheet" type="text/css" href="/gitweb.css"/>
<link rel="alternate" title="dragonfly.git - history of lib/libstand/hammerread.c - RSS feed" href="/dragonfly.git/rss?f=lib/libstand/hammerread.c" type="application/rss+xml" />
<link rel="alternate" title="dragonfly.git - history of lib/libstand/hammerread.c - RSS feed (no merges)" href="/dragonfly.git/rss?f=lib/libstand/hammerread.c;opt=--no-merges" type="application/rss+xml" />
<link rel="alternate" title="dragonfly.git - history of lib/libstand/hammerread.c - Atom feed" href="/dragonfly.git/atom?f=lib/libstand/hammerread.c;opt=--no-merges" type="application/atom+xml" />
<link rel="alternate" title="dragonfly.git - history of lib/libstand/hammerread.c - Atom feed (no merges)" href="/dragonfly.git/atom?f=lib/libstand/hammerread.c;opt=--no-merges" type="application/atom+xml" />
<link rel="shortcut icon" href="/git-favicon.png" type="image/png" />
</head>
<body>
<div class="page_header">
<a title="git homepage" href="http://git-scm.com/"><img src="/git-logo.png" width="72" height="27" alt="git" class="logo"/></a><a href="/">projects</a> / <a href="/dragonfly.git">dragonfly.git</a> / blob
</div>
<form method="get" action="/dragonfly.git" enctype="application/x-www-form-urlencoded">
<div class="search">
<input name="a" type="hidden" value="search" />
<input name="h" type="hidden" value="463f2cb11593931f1a7f29a13e8a1bf9fb9ecba6" />
<select name="st" >
<option selected="selected" value="commit">commit</option>
<option value="grep">grep</option>
<option value="author">author</option>
<option value="committer">committer</option>
<option value="pickaxe">pickaxe</option>
</select><sup><a href="/dragonfly.git/search_help">?</a></sup> search:
<input type="text" name="s"  />
<span title="Extended regular expression"><label><input type="checkbox" name="sr" value="1" />re</label></span></div>
</form>
<div class="page_nav">
<a href="/dragonfly.git">summary</a> | <a href="/dragonfly.git/shortlog">shortlog</a> | <a href="/dragonfly.git/log">log</a> | <a href="/dragonfly.git/commit/463f2cb11593931f1a7f29a13e8a1bf9fb9ecba6">commit</a> | <a href="/dragonfly.git/commitdiff/463f2cb11593931f1a7f29a13e8a1bf9fb9ecba6">commitdiff</a> | <a href="/dragonfly.git/tree/463f2cb11593931f1a7f29a13e8a1bf9fb9ecba6">tree</a><br/>
<a href="/dragonfly.git/blame/463f2cb11593931f1a7f29a13e8a1bf9fb9ecba6:/lib/libstand/hammerread.c">blame</a> | <a href="/dragonfly.git/history/463f2cb11593931f1a7f29a13e8a1bf9fb9ecba6:/lib/libstand/hammerread.c">history</a> | <a href="/dragonfly.git/blob_plain/463f2cb11593931f1a7f29a13e8a1bf9fb9ecba6:/lib/libstand/hammerread.c">raw</a> | <a href="/dragonfly.git/blob/HEAD:/lib/libstand/hammerread.c">HEAD</a><br/>
</div>
<div class="header">
<a class="title" href="/dragonfly.git/commit/463f2cb11593931f1a7f29a13e8a1bf9fb9ecba6">Properly use HAMMER_BUFMASK64 when taking the complement.</a>
</div>
<div class="page_path"><a title="tree root" href="/dragonfly.git/tree/463f2cb11593931f1a7f29a13e8a1bf9fb9ecba6">[dragonfly.git]</a> / <a title="lib" href="/dragonfly.git/tree/463f2cb11593931f1a7f29a13e8a1bf9fb9ecba6:/lib">lib</a> / <a title="lib/libstand" href="/dragonfly.git/tree/463f2cb11593931f1a7f29a13e8a1bf9fb9ecba6:/lib/libstand">libstand</a> / <a title="lib/libstand/hammerread.c" href="/dragonfly.git/blob_plain/463f2cb11593931f1a7f29a13e8a1bf9fb9ecba6:/lib/libstand/hammerread.c">hammerread.c</a><br/></div>
<div class="page_body">
<div class="pre"><a id="l1" href="#l1" class="linenr">   1</a> /*</div>
<div class="pre"><a id="l2" href="#l2" class="linenr">   2</a> &nbsp;*&nbsp;Copyright&nbsp;(c)&nbsp;2008&nbsp;The&nbsp;DragonFly&nbsp;Project.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</div>
<div class="pre"><a id="l3" href="#l3" class="linenr">   3</a> &nbsp;*</div>
<div class="pre"><a id="l4" href="#l4" class="linenr">   4</a> &nbsp;*&nbsp;This&nbsp;code&nbsp;is&nbsp;derived&nbsp;from&nbsp;software&nbsp;contributed&nbsp;to&nbsp;The&nbsp;DragonFly&nbsp;Project</div>
<div class="pre"><a id="l5" href="#l5" class="linenr">   5</a> &nbsp;*&nbsp;by&nbsp;Simon&nbsp;Schubert&nbsp;&lt;corecode@fs.ei.tum.de&gt;</div>
<div class="pre"><a id="l6" href="#l6" class="linenr">   6</a> &nbsp;*&nbsp;and&nbsp;Matthew&nbsp;Dillon&nbsp;&lt;dillon@backplane.com&gt;</div>
<div class="pre"><a id="l7" href="#l7" class="linenr">   7</a> &nbsp;*</div>
<div class="pre"><a id="l8" href="#l8" class="linenr">   8</a> &nbsp;*&nbsp;Redistribution&nbsp;and&nbsp;use&nbsp;in&nbsp;source&nbsp;and&nbsp;binary&nbsp;forms,&nbsp;with&nbsp;or&nbsp;without</div>
<div class="pre"><a id="l9" href="#l9" class="linenr">   9</a> &nbsp;*&nbsp;modification,&nbsp;are&nbsp;permitted&nbsp;provided&nbsp;that&nbsp;the&nbsp;following&nbsp;conditions</div>
<div class="pre"><a id="l10" href="#l10" class="linenr">  10</a> &nbsp;*&nbsp;are&nbsp;met:</div>
<div class="pre"><a id="l11" href="#l11" class="linenr">  11</a> &nbsp;*</div>
<div class="pre"><a id="l12" href="#l12" class="linenr">  12</a> &nbsp;*&nbsp;1.&nbsp;Redistributions&nbsp;of&nbsp;source&nbsp;code&nbsp;must&nbsp;retain&nbsp;the&nbsp;above&nbsp;copyright</div>
<div class="pre"><a id="l13" href="#l13" class="linenr">  13</a> &nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;notice,&nbsp;this&nbsp;list&nbsp;of&nbsp;conditions&nbsp;and&nbsp;the&nbsp;following&nbsp;disclaimer.</div>
<div class="pre"><a id="l14" href="#l14" class="linenr">  14</a> &nbsp;*&nbsp;2.&nbsp;Redistributions&nbsp;in&nbsp;binary&nbsp;form&nbsp;must&nbsp;reproduce&nbsp;the&nbsp;above&nbsp;copyright</div>
<div class="pre"><a id="l15" href="#l15" class="linenr">  15</a> &nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;notice,&nbsp;this&nbsp;list&nbsp;of&nbsp;conditions&nbsp;and&nbsp;the&nbsp;following&nbsp;disclaimer&nbsp;in</div>
<div class="pre"><a id="l16" href="#l16" class="linenr">  16</a> &nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;documentation&nbsp;and/or&nbsp;other&nbsp;materials&nbsp;provided&nbsp;with&nbsp;the</div>
<div class="pre"><a id="l17" href="#l17" class="linenr">  17</a> &nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;distribution.</div>
<div class="pre"><a id="l18" href="#l18" class="linenr">  18</a> &nbsp;*&nbsp;3.&nbsp;Neither&nbsp;the&nbsp;name&nbsp;of&nbsp;The&nbsp;DragonFly&nbsp;Project&nbsp;nor&nbsp;the&nbsp;names&nbsp;of&nbsp;its</div>
<div class="pre"><a id="l19" href="#l19" class="linenr">  19</a> &nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;contributors&nbsp;may&nbsp;be&nbsp;used&nbsp;to&nbsp;endorse&nbsp;or&nbsp;promote&nbsp;products&nbsp;derived</div>
<div class="pre"><a id="l20" href="#l20" class="linenr">  20</a> &nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;this&nbsp;software&nbsp;without&nbsp;specific,&nbsp;prior&nbsp;written&nbsp;permission.</div>
<div class="pre"><a id="l21" href="#l21" class="linenr">  21</a> &nbsp;*</div>
<div class="pre"><a id="l22" href="#l22" class="linenr">  22</a> &nbsp;*&nbsp;THIS&nbsp;SOFTWARE&nbsp;IS&nbsp;PROVIDED&nbsp;BY&nbsp;THE&nbsp;COPYRIGHT&nbsp;HOLDERS&nbsp;AND&nbsp;CONTRIBUTORS</div>
<div class="pre"><a id="l23" href="#l23" class="linenr">  23</a> &nbsp;*&nbsp;``AS&nbsp;IS''&nbsp;AND&nbsp;ANY&nbsp;EXPRESS&nbsp;OR&nbsp;IMPLIED&nbsp;WARRANTIES,&nbsp;INCLUDING,&nbsp;BUT&nbsp;NOT</div>
<div class="pre"><a id="l24" href="#l24" class="linenr">  24</a> &nbsp;*&nbsp;LIMITED&nbsp;TO,&nbsp;THE&nbsp;IMPLIED&nbsp;WARRANTIES&nbsp;OF&nbsp;MERCHANTABILITY&nbsp;AND&nbsp;FITNESS</div>
<div class="pre"><a id="l25" href="#l25" class="linenr">  25</a> &nbsp;*&nbsp;FOR&nbsp;A&nbsp;PARTICULAR&nbsp;PURPOSE&nbsp;ARE&nbsp;DISCLAIMED.&nbsp;&nbsp;IN&nbsp;NO&nbsp;EVENT&nbsp;SHALL&nbsp;THE</div>
<div class="pre"><a id="l26" href="#l26" class="linenr">  26</a> &nbsp;*&nbsp;COPYRIGHT&nbsp;HOLDERS&nbsp;OR&nbsp;CONTRIBUTORS&nbsp;BE&nbsp;LIABLE&nbsp;FOR&nbsp;ANY&nbsp;DIRECT,&nbsp;INDIRECT,</div>
<div class="pre"><a id="l27" href="#l27" class="linenr">  27</a> &nbsp;*&nbsp;INCIDENTAL,&nbsp;SPECIAL,&nbsp;EXEMPLARY&nbsp;OR&nbsp;CONSEQUENTIAL&nbsp;DAMAGES&nbsp;(INCLUDING,</div>
<div class="pre"><a id="l28" href="#l28" class="linenr">  28</a> &nbsp;*&nbsp;BUT&nbsp;NOT&nbsp;LIMITED&nbsp;TO,&nbsp;PROCUREMENT&nbsp;OF&nbsp;SUBSTITUTE&nbsp;GOODS&nbsp;OR&nbsp;SERVICES;</div>
<div class="pre"><a id="l29" href="#l29" class="linenr">  29</a> &nbsp;*&nbsp;LOSS&nbsp;OF&nbsp;USE,&nbsp;DATA,&nbsp;OR&nbsp;PROFITS;&nbsp;OR&nbsp;BUSINESS&nbsp;INTERRUPTION)&nbsp;HOWEVER&nbsp;CAUSED</div>
<div class="pre"><a id="l30" href="#l30" class="linenr">  30</a> &nbsp;*&nbsp;AND&nbsp;ON&nbsp;ANY&nbsp;THEORY&nbsp;OF&nbsp;LIABILITY,&nbsp;WHETHER&nbsp;IN&nbsp;CONTRACT,&nbsp;STRICT&nbsp;LIABILITY,</div>
<div class="pre"><a id="l31" href="#l31" class="linenr">  31</a> &nbsp;*&nbsp;OR&nbsp;TORT&nbsp;(INCLUDING&nbsp;NEGLIGENCE&nbsp;OR&nbsp;OTHERWISE)&nbsp;ARISING&nbsp;IN&nbsp;ANY&nbsp;WAY&nbsp;OUT</div>
<div class="pre"><a id="l32" href="#l32" class="linenr">  32</a> &nbsp;*&nbsp;OF&nbsp;THE&nbsp;USE&nbsp;OF&nbsp;THIS&nbsp;SOFTWARE,&nbsp;EVEN&nbsp;IF&nbsp;ADVISED&nbsp;OF&nbsp;THE&nbsp;POSSIBILITY&nbsp;OF</div>
<div class="pre"><a id="l33" href="#l33" class="linenr">  33</a> &nbsp;*&nbsp;SUCH&nbsp;DAMAGE.</div>
<div class="pre"><a id="l34" href="#l34" class="linenr">  34</a> &nbsp;*</div>
<div class="pre"><a id="l35" href="#l35" class="linenr">  35</a> &nbsp;*&nbsp;$DragonFly:&nbsp;src/lib/libstand/hammerread.c,v&nbsp;1.2&nbsp;2008/10/29&nbsp;22:14:25&nbsp;swildner&nbsp;Exp&nbsp;$</div>
<div class="pre"><a id="l36" href="#l36" class="linenr">  36</a> &nbsp;*/</div>
<div class="pre"><a id="l37" href="#l37" class="linenr">  37</a> </div>
<div class="pre"><a id="l38" href="#l38" class="linenr">  38</a> /*</div>
<div class="pre"><a id="l39" href="#l39" class="linenr">  39</a> &nbsp;*&nbsp;This&nbsp;file&nbsp;is&nbsp;being&nbsp;used&nbsp;by&nbsp;boot2&nbsp;and&nbsp;libstand&nbsp;(loader).</div>
<div class="pre"><a id="l40" href="#l40" class="linenr">  40</a> &nbsp;*&nbsp;Compile&nbsp;with&nbsp;-DTESTING&nbsp;to&nbsp;obtain&nbsp;a&nbsp;binary.</div>
<div class="pre"><a id="l41" href="#l41" class="linenr">  41</a> &nbsp;*/</div>
<div class="pre"><a id="l42" href="#l42" class="linenr">  42</a> </div>
<div class="pre"><a id="l43" href="#l43" class="linenr">  43</a> </div>
<div class="pre"><a id="l44" href="#l44" class="linenr">  44</a> #if&nbsp;!defined(BOOT2)&nbsp;&amp;&amp;&nbsp;!defined(TESTING)</div>
<div class="pre"><a id="l45" href="#l45" class="linenr">  45</a> #define&nbsp;LIBSTAND&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1</div>
<div class="pre"><a id="l46" href="#l46" class="linenr">  46</a> #endif</div>
<div class="pre"><a id="l47" href="#l47" class="linenr">  47</a> </div>
<div class="pre"><a id="l48" href="#l48" class="linenr">  48</a> #include&nbsp;&lt;sys/param.h&gt;</div>
<div class="pre"><a id="l49" href="#l49" class="linenr">  49</a> </div>
<div class="pre"><a id="l50" href="#l50" class="linenr">  50</a> #include&nbsp;&lt;stddef.h&gt;</div>
<div class="pre"><a id="l51" href="#l51" class="linenr">  51</a> #include&nbsp;&lt;stdint.h&gt;</div>
<div class="pre"><a id="l52" href="#l52" class="linenr">  52</a> </div>
<div class="pre"><a id="l53" href="#l53" class="linenr">  53</a> #ifdef&nbsp;TESTING</div>
<div class="pre"><a id="l54" href="#l54" class="linenr">  54</a> #include&nbsp;&lt;sys/fcntl.h&gt;</div>
<div class="pre"><a id="l55" href="#l55" class="linenr">  55</a> #include&nbsp;&lt;sys/stat.h&gt;</div>
<div class="pre"><a id="l56" href="#l56" class="linenr">  56</a> #include&nbsp;&lt;unistd.h&gt;</div>
<div class="pre"><a id="l57" href="#l57" class="linenr">  57</a> #include&nbsp;&lt;err.h&gt;</div>
<div class="pre"><a id="l58" href="#l58" class="linenr">  58</a> #include&nbsp;&lt;stdio.h&gt;</div>
<div class="pre"><a id="l59" href="#l59" class="linenr">  59</a> #include&nbsp;&lt;stdlib.h&gt;</div>
<div class="pre"><a id="l60" href="#l60" class="linenr">  60</a> #include&nbsp;&lt;string.h&gt;</div>
<div class="pre"><a id="l61" href="#l61" class="linenr">  61</a> #include&nbsp;&lt;errno.h&gt;</div>
<div class="pre"><a id="l62" href="#l62" class="linenr">  62</a> #include&nbsp;&lt;dirent.h&gt;</div>
<div class="pre"><a id="l63" href="#l63" class="linenr">  63</a> #endif</div>
<div class="pre"><a id="l64" href="#l64" class="linenr">  64</a> </div>
<div class="pre"><a id="l65" href="#l65" class="linenr">  65</a> #ifdef&nbsp;LIBSTAND</div>
<div class="pre"><a id="l66" href="#l66" class="linenr">  66</a> #include&nbsp;&quot;stand.h&quot;</div>
<div class="pre"><a id="l67" href="#l67" class="linenr">  67</a> #endif</div>
<div class="pre"><a id="l68" href="#l68" class="linenr">  68</a> </div>
<div class="pre"><a id="l69" href="#l69" class="linenr">  69</a> #include&nbsp;&lt;vfs/hammer/hammer_disk.h&gt;</div>
<div class="pre"><a id="l70" href="#l70" class="linenr">  70</a> </div>
<div class="pre"><a id="l71" href="#l71" class="linenr">  71</a> #ifndef&nbsp;BOOT2</div>
<div class="pre"><a id="l72" href="#l72" class="linenr">  72</a> struct&nbsp;blockentry&nbsp;{</div>
<div class="pre"><a id="l73" href="#l73" class="linenr">  73</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_off_t&nbsp;&nbsp;&nbsp;&nbsp;off;</div>
<div class="pre"><a id="l74" href="#l74" class="linenr">  74</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;use;</div>
<div class="pre"><a id="l75" href="#l75" class="linenr">  75</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*data;</div>
<div class="pre"><a id="l76" href="#l76" class="linenr">  76</a> };</div>
<div class="pre"><a id="l77" href="#l77" class="linenr">  77</a> </div>
<div class="pre"><a id="l78" href="#l78" class="linenr">  78</a> #ifdef&nbsp;TESTING</div>
<div class="pre"><a id="l79" href="#l79" class="linenr">  79</a> #define&nbsp;NUMCACHE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;16</div>
<div class="pre"><a id="l80" href="#l80" class="linenr">  80</a> #else</div>
<div class="pre"><a id="l81" href="#l81" class="linenr">  81</a> #define&nbsp;NUMCACHE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6</div>
<div class="pre"><a id="l82" href="#l82" class="linenr">  82</a> #endif</div>
<div class="pre"><a id="l83" href="#l83" class="linenr">  83</a> </div>
<div class="pre"><a id="l84" href="#l84" class="linenr">  84</a> struct&nbsp;hfs&nbsp;{</div>
<div class="pre"><a id="l85" href="#l85" class="linenr">  85</a> #ifdef&nbsp;TESTING</div>
<div class="pre"><a id="l86" href="#l86" class="linenr">  86</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fd;</div>
<div class="pre"><a id="l87" href="#l87" class="linenr">  87</a> #else&nbsp;&nbsp;&nbsp;//&nbsp;libstand</div>
<div class="pre"><a id="l88" href="#l88" class="linenr">  88</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;open_file&nbsp;*f;</div>
<div class="pre"><a id="l89" href="#l89" class="linenr">  89</a> #endif</div>
<div class="pre"><a id="l90" href="#l90" class="linenr">  90</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_off_t&nbsp;&nbsp;&nbsp;&nbsp;root;</div>
<div class="pre"><a id="l91" href="#l91" class="linenr">  91</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf_beg;</div>
<div class="pre"><a id="l92" href="#l92" class="linenr">  92</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lru;</div>
<div class="pre"><a id="l93" href="#l93" class="linenr">  93</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;blockentry&nbsp;cache[NUMCACHE];</div>
<div class="pre"><a id="l94" href="#l94" class="linenr">  94</a> };</div>
<div class="pre"><a id="l95" href="#l95" class="linenr">  95</a> </div>
<div class="pre"><a id="l96" href="#l96" class="linenr">  96</a> static&nbsp;void&nbsp;*</div>
<div class="pre"><a id="l97" href="#l97" class="linenr">  97</a> hread(struct&nbsp;hfs&nbsp;*hfs,&nbsp;hammer_off_t&nbsp;off)</div>
<div class="pre"><a id="l98" href="#l98" class="linenr">  98</a> {</div>
<div class="pre"><a id="l99" href="#l99" class="linenr">  99</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_off_t&nbsp;boff&nbsp;=&nbsp;off&nbsp;&amp;&nbsp;~HAMMER_BUFMASK64;</div>
<div class="pre"><a id="l100" href="#l100" class="linenr"> 100</a> </div>
<div class="pre"><a id="l101" href="#l101" class="linenr"> 101</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boff&nbsp;&amp;=&nbsp;HAMMER_OFF_LONG_MASK;</div>
<div class="pre"><a id="l102" href="#l102" class="linenr"> 102</a> </div>
<div class="pre"><a id="l103" href="#l103" class="linenr"> 103</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(HAMMER_ZONE_DECODE(off)&nbsp;!=&nbsp;HAMMER_ZONE_RAW_VOLUME_INDEX)</div>
<div class="pre"><a id="l104" href="#l104" class="linenr"> 104</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boff&nbsp;+=&nbsp;hfs-&gt;buf_beg;</div>
<div class="pre"><a id="l105" href="#l105" class="linenr"> 105</a> </div>
<div class="pre"><a id="l106" href="#l106" class="linenr"> 106</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;blockentry&nbsp;*be&nbsp;=&nbsp;NULL;</div>
<div class="pre"><a id="l107" href="#l107" class="linenr"> 107</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;NUMCACHE;&nbsp;i++)&nbsp;{</div>
<div class="pre"><a id="l108" href="#l108" class="linenr"> 108</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(be&nbsp;==&nbsp;NULL&nbsp;||&nbsp;be-&gt;use&nbsp;&gt;&nbsp;hfs-&gt;cache[i].use)</div>
<div class="pre"><a id="l109" href="#l109" class="linenr"> 109</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;be&nbsp;=&nbsp;&amp;hfs-&gt;cache[i];</div>
<div class="pre"><a id="l110" href="#l110" class="linenr"> 110</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hfs-&gt;cache[i].off&nbsp;==&nbsp;boff)&nbsp;{</div>
<div class="pre"><a id="l111" href="#l111" class="linenr"> 111</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;be&nbsp;=&nbsp;&amp;hfs-&gt;cache[i];</div>
<div class="pre"><a id="l112" href="#l112" class="linenr"> 112</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</div>
<div class="pre"><a id="l113" href="#l113" class="linenr"> 113</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l114" href="#l114" class="linenr"> 114</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l115" href="#l115" class="linenr"> 115</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(be-&gt;off&nbsp;!=&nbsp;boff)&nbsp;{</div>
<div class="pre"><a id="l116" href="#l116" class="linenr"> 116</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Didn't&nbsp;find&nbsp;any&nbsp;match</div>
<div class="pre"><a id="l117" href="#l117" class="linenr"> 117</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;be-&gt;off&nbsp;=&nbsp;boff;</div>
<div class="pre"><a id="l118" href="#l118" class="linenr"> 118</a> #ifdef&nbsp;TESTING</div>
<div class="pre"><a id="l119" href="#l119" class="linenr"> 119</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssize_t&nbsp;res&nbsp;=&nbsp;pread(hfs-&gt;fd,&nbsp;be-&gt;data,&nbsp;HAMMER_BUFSIZE,</div>
<div class="pre"><a id="l120" href="#l120" class="linenr"> 120</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boff&nbsp;&amp;&nbsp;HAMMER_OFF_SHORT_MASK);</div>
<div class="pre"><a id="l121" href="#l121" class="linenr"> 121</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(res&nbsp;!=&nbsp;HAMMER_BUFSIZE)</div>
<div class="pre"><a id="l122" href="#l122" class="linenr"> 122</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err(1,&nbsp;&quot;short&nbsp;read&nbsp;on&nbsp;off&nbsp;%llx&quot;,&nbsp;boff);</div>
<div class="pre"><a id="l123" href="#l123" class="linenr"> 123</a> #else&nbsp;&nbsp;&nbsp;//&nbsp;libstand</div>
<div class="pre"><a id="l124" href="#l124" class="linenr"> 124</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;rlen;</div>
<div class="pre"><a id="l125" href="#l125" class="linenr"> 125</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;rv&nbsp;=&nbsp;hfs-&gt;f-&gt;f_dev-&gt;dv_strategy(hfs-&gt;f-&gt;f_devdata,&nbsp;F_READ,</div>
<div class="pre"><a id="l126" href="#l126" class="linenr"> 126</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boff&nbsp;&gt;&gt;&nbsp;DEV_BSHIFT,&nbsp;HAMMER_BUFSIZE,</div>
<div class="pre"><a id="l127" href="#l127" class="linenr"> 127</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;be-&gt;data,&nbsp;&amp;rlen);</div>
<div class="pre"><a id="l128" href="#l128" class="linenr"> 128</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(rv&nbsp;||&nbsp;rlen&nbsp;!=&nbsp;HAMMER_BUFSIZE)</div>
<div class="pre"><a id="l129" href="#l129" class="linenr"> 129</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(NULL);</div>
<div class="pre"><a id="l130" href="#l130" class="linenr"> 130</a> #endif</div>
<div class="pre"><a id="l131" href="#l131" class="linenr"> 131</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l132" href="#l132" class="linenr"> 132</a> </div>
<div class="pre"><a id="l133" href="#l133" class="linenr"> 133</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;be-&gt;use&nbsp;=&nbsp;++hfs-&gt;lru;</div>
<div class="pre"><a id="l134" href="#l134" class="linenr"> 134</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;be-&gt;data[off&nbsp;&amp;&nbsp;HAMMER_BUFMASK];</div>
<div class="pre"><a id="l135" href="#l135" class="linenr"> 135</a> }</div>
<div class="pre"><a id="l136" href="#l136" class="linenr"> 136</a> </div>
<div class="pre"><a id="l137" href="#l137" class="linenr"> 137</a> #else&nbsp;&nbsp;&nbsp;/*&nbsp;BOOT2&nbsp;*/</div>
<div class="pre"><a id="l138" href="#l138" class="linenr"> 138</a> </div>
<div class="pre"><a id="l139" href="#l139" class="linenr"> 139</a> struct&nbsp;dmadat&nbsp;{</div>
<div class="pre"><a id="l140" href="#l140" class="linenr"> 140</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;secbuf[DEV_BSIZE];</div>
<div class="pre"><a id="l141" href="#l141" class="linenr"> 141</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf[HAMMER_BUFSIZE];</div>
<div class="pre"><a id="l142" href="#l142" class="linenr"> 142</a> };</div>
<div class="pre"><a id="l143" href="#l143" class="linenr"> 143</a> </div>
<div class="pre"><a id="l144" href="#l144" class="linenr"> 144</a> static&nbsp;struct&nbsp;dmadat&nbsp;*dmadat;</div>
<div class="pre"><a id="l145" href="#l145" class="linenr"> 145</a> </div>
<div class="pre"><a id="l146" href="#l146" class="linenr"> 146</a> struct&nbsp;hfs&nbsp;{</div>
<div class="pre"><a id="l147" href="#l147" class="linenr"> 147</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_off_t&nbsp;&nbsp;&nbsp;&nbsp;root;</div>
<div class="pre"><a id="l148" href="#l148" class="linenr"> 148</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf_beg;</div>
<div class="pre"><a id="l149" href="#l149" class="linenr"> 149</a> };</div>
<div class="pre"><a id="l150" href="#l150" class="linenr"> 150</a> </div>
<div class="pre"><a id="l151" href="#l151" class="linenr"> 151</a> static&nbsp;void&nbsp;*</div>
<div class="pre"><a id="l152" href="#l152" class="linenr"> 152</a> hread(struct&nbsp;hfs&nbsp;*hfs,&nbsp;hammer_off_t&nbsp;off)</div>
<div class="pre"><a id="l153" href="#l153" class="linenr"> 153</a> {</div>
<div class="pre"><a id="l154" href="#l154" class="linenr"> 154</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;*buf&nbsp;=&nbsp;dmadat-&gt;buf;</div>
<div class="pre"><a id="l155" href="#l155" class="linenr"> 155</a> </div>
<div class="pre"><a id="l156" href="#l156" class="linenr"> 156</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_off_t&nbsp;boff&nbsp;=&nbsp;off&nbsp;&amp;&nbsp;~HAMMER_BUFMASK64;</div>
<div class="pre"><a id="l157" href="#l157" class="linenr"> 157</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boff&nbsp;&amp;=&nbsp;HAMMER_OFF_LONG_MASK;</div>
<div class="pre"><a id="l158" href="#l158" class="linenr"> 158</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(HAMMER_ZONE_DECODE(off)&nbsp;!=&nbsp;HAMMER_ZONE_RAW_VOLUME_INDEX)</div>
<div class="pre"><a id="l159" href="#l159" class="linenr"> 159</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boff&nbsp;+=&nbsp;hfs-&gt;buf_beg;</div>
<div class="pre"><a id="l160" href="#l160" class="linenr"> 160</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boff&nbsp;&amp;=&nbsp;HAMMER_OFF_SHORT_MASK;</div>
<div class="pre"><a id="l161" href="#l161" class="linenr"> 161</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boff&nbsp;&gt;&gt;=&nbsp;DEV_BSHIFT;</div>
<div class="pre"><a id="l162" href="#l162" class="linenr"> 162</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(dskread(buf,&nbsp;boff,&nbsp;HAMMER_BUFSIZE&nbsp;&gt;&gt;&nbsp;DEV_BSHIFT))</div>
<div class="pre"><a id="l163" href="#l163" class="linenr"> 163</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(NULL);</div>
<div class="pre"><a id="l164" href="#l164" class="linenr"> 164</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(&amp;buf[off&nbsp;&amp;&nbsp;HAMMER_BUFMASK]);</div>
<div class="pre"><a id="l165" href="#l165" class="linenr"> 165</a> }</div>
<div class="pre"><a id="l166" href="#l166" class="linenr"> 166</a> </div>
<div class="pre"><a id="l167" href="#l167" class="linenr"> 167</a> static&nbsp;void</div>
<div class="pre"><a id="l168" href="#l168" class="linenr"> 168</a> bzero(void&nbsp;*buf,&nbsp;size_t&nbsp;size)</div>
<div class="pre"><a id="l169" href="#l169" class="linenr"> 169</a> {</div>
<div class="pre"><a id="l170" href="#l170" class="linenr"> 170</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(size_t&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;size;&nbsp;i++)</div>
<div class="pre"><a id="l171" href="#l171" class="linenr"> 171</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((char&nbsp;*)buf)[i]&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l172" href="#l172" class="linenr"> 172</a> }</div>
<div class="pre"><a id="l173" href="#l173" class="linenr"> 173</a> </div>
<div class="pre"><a id="l174" href="#l174" class="linenr"> 174</a> static&nbsp;void</div>
<div class="pre"><a id="l175" href="#l175" class="linenr"> 175</a> bcopy(void&nbsp;*src,&nbsp;void&nbsp;*dst,&nbsp;size_t&nbsp;size)</div>
<div class="pre"><a id="l176" href="#l176" class="linenr"> 176</a> {</div>
<div class="pre"><a id="l177" href="#l177" class="linenr"> 177</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy(dst,&nbsp;src,&nbsp;size);</div>
<div class="pre"><a id="l178" href="#l178" class="linenr"> 178</a> }</div>
<div class="pre"><a id="l179" href="#l179" class="linenr"> 179</a> </div>
<div class="pre"><a id="l180" href="#l180" class="linenr"> 180</a> static&nbsp;size_t</div>
<div class="pre"><a id="l181" href="#l181" class="linenr"> 181</a> strlen(const&nbsp;char&nbsp;*s)</div>
<div class="pre"><a id="l182" href="#l182" class="linenr"> 182</a> {</div>
<div class="pre"><a id="l183" href="#l183" class="linenr"> 183</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;l&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l184" href="#l184" class="linenr"> 184</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(;&nbsp;*s&nbsp;!=&nbsp;0;&nbsp;s++)</div>
<div class="pre"><a id="l185" href="#l185" class="linenr"> 185</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l++;</div>
<div class="pre"><a id="l186" href="#l186" class="linenr"> 186</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(l);</div>
<div class="pre"><a id="l187" href="#l187" class="linenr"> 187</a> }</div>
<div class="pre"><a id="l188" href="#l188" class="linenr"> 188</a> </div>
<div class="pre"><a id="l189" href="#l189" class="linenr"> 189</a> static&nbsp;int</div>
<div class="pre"><a id="l190" href="#l190" class="linenr"> 190</a> memcmp(const&nbsp;void&nbsp;*a,&nbsp;const&nbsp;void&nbsp;*b,&nbsp;size_t&nbsp;len)</div>
<div class="pre"><a id="l191" href="#l191" class="linenr"> 191</a> {</div>
<div class="pre"><a id="l192" href="#l192" class="linenr"> 192</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(size_t&nbsp;p&nbsp;=&nbsp;0;&nbsp;p&nbsp;&lt;&nbsp;len;&nbsp;p++)&nbsp;{</div>
<div class="pre"><a id="l193" href="#l193" class="linenr"> 193</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;r&nbsp;=&nbsp;((const&nbsp;char&nbsp;*)a)[p]&nbsp;-&nbsp;((const&nbsp;char&nbsp;*)b)[p];</div>
<div class="pre"><a id="l194" href="#l194" class="linenr"> 194</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(r&nbsp;!=&nbsp;0)</div>
<div class="pre"><a id="l195" href="#l195" class="linenr"> 195</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(r);</div>
<div class="pre"><a id="l196" href="#l196" class="linenr"> 196</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l197" href="#l197" class="linenr"> 197</a> </div>
<div class="pre"><a id="l198" href="#l198" class="linenr"> 198</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(0);</div>
<div class="pre"><a id="l199" href="#l199" class="linenr"> 199</a> }</div>
<div class="pre"><a id="l200" href="#l200" class="linenr"> 200</a> </div>
<div class="pre"><a id="l201" href="#l201" class="linenr"> 201</a> #endif</div>
<div class="pre"><a id="l202" href="#l202" class="linenr"> 202</a> </div>
<div class="pre"><a id="l203" href="#l203" class="linenr"> 203</a> /*</div>
<div class="pre"><a id="l204" href="#l204" class="linenr"> 204</a> &nbsp;*&nbsp;(from&nbsp;hammer_btree.c)</div>
<div class="pre"><a id="l205" href="#l205" class="linenr"> 205</a> &nbsp;*</div>
<div class="pre"><a id="l206" href="#l206" class="linenr"> 206</a> &nbsp;*&nbsp;Compare&nbsp;two&nbsp;B-Tree&nbsp;elements,&nbsp;return&nbsp;-N,&nbsp;0,&nbsp;or&nbsp;+N&nbsp;(e.g.&nbsp;similar&nbsp;to&nbsp;strcmp).</div>
<div class="pre"><a id="l207" href="#l207" class="linenr"> 207</a> &nbsp;*</div>
<div class="pre"><a id="l208" href="#l208" class="linenr"> 208</a> &nbsp;*&nbsp;Note&nbsp;that&nbsp;for&nbsp;this&nbsp;particular&nbsp;function&nbsp;a&nbsp;return&nbsp;value&nbsp;of&nbsp;-1,&nbsp;0,&nbsp;or&nbsp;+1</div>
<div class="pre"><a id="l209" href="#l209" class="linenr"> 209</a> &nbsp;*&nbsp;can&nbsp;denote&nbsp;a&nbsp;match&nbsp;if&nbsp;create_tid&nbsp;is&nbsp;otherwise&nbsp;discounted.&nbsp;&nbsp;A&nbsp;create_tid</div>
<div class="pre"><a id="l210" href="#l210" class="linenr"> 210</a> &nbsp;*&nbsp;of&nbsp;zero&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;'infinity'&nbsp;in&nbsp;comparisons.</div>
<div class="pre"><a id="l211" href="#l211" class="linenr"> 211</a> &nbsp;*</div>
<div class="pre"><a id="l212" href="#l212" class="linenr"> 212</a> &nbsp;*&nbsp;See&nbsp;also&nbsp;hammer_rec_rb_compare()&nbsp;and&nbsp;hammer_rec_cmp()&nbsp;in&nbsp;hammer_object.c.</div>
<div class="pre"><a id="l213" href="#l213" class="linenr"> 213</a> &nbsp;*/</div>
<div class="pre"><a id="l214" href="#l214" class="linenr"> 214</a> static&nbsp;int</div>
<div class="pre"><a id="l215" href="#l215" class="linenr"> 215</a> hammer_btree_cmp(hammer_base_elm_t&nbsp;key1,&nbsp;hammer_base_elm_t&nbsp;key2)</div>
<div class="pre"><a id="l216" href="#l216" class="linenr"> 216</a> {</div>
<div class="pre"><a id="l217" href="#l217" class="linenr"> 217</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key1-&gt;localization&nbsp;&lt;&nbsp;key2-&gt;localization)</div>
<div class="pre"><a id="l218" href="#l218" class="linenr"> 218</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(-5);</div>
<div class="pre"><a id="l219" href="#l219" class="linenr"> 219</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key1-&gt;localization&nbsp;&gt;&nbsp;key2-&gt;localization)</div>
<div class="pre"><a id="l220" href="#l220" class="linenr"> 220</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(5);</div>
<div class="pre"><a id="l221" href="#l221" class="linenr"> 221</a> </div>
<div class="pre"><a id="l222" href="#l222" class="linenr"> 222</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key1-&gt;obj_id&nbsp;&lt;&nbsp;key2-&gt;obj_id)</div>
<div class="pre"><a id="l223" href="#l223" class="linenr"> 223</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(-4);</div>
<div class="pre"><a id="l224" href="#l224" class="linenr"> 224</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key1-&gt;obj_id&nbsp;&gt;&nbsp;key2-&gt;obj_id)</div>
<div class="pre"><a id="l225" href="#l225" class="linenr"> 225</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(4);</div>
<div class="pre"><a id="l226" href="#l226" class="linenr"> 226</a> </div>
<div class="pre"><a id="l227" href="#l227" class="linenr"> 227</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key1-&gt;rec_type&nbsp;&lt;&nbsp;key2-&gt;rec_type)</div>
<div class="pre"><a id="l228" href="#l228" class="linenr"> 228</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(-3);</div>
<div class="pre"><a id="l229" href="#l229" class="linenr"> 229</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key1-&gt;rec_type&nbsp;&gt;&nbsp;key2-&gt;rec_type)</div>
<div class="pre"><a id="l230" href="#l230" class="linenr"> 230</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(3);</div>
<div class="pre"><a id="l231" href="#l231" class="linenr"> 231</a> </div>
<div class="pre"><a id="l232" href="#l232" class="linenr"> 232</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key1-&gt;key&nbsp;&lt;&nbsp;key2-&gt;key)</div>
<div class="pre"><a id="l233" href="#l233" class="linenr"> 233</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(-2);</div>
<div class="pre"><a id="l234" href="#l234" class="linenr"> 234</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key1-&gt;key&nbsp;&gt;&nbsp;key2-&gt;key)</div>
<div class="pre"><a id="l235" href="#l235" class="linenr"> 235</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(2);</div>
<div class="pre"><a id="l236" href="#l236" class="linenr"> 236</a> </div>
<div class="pre"><a id="l237" href="#l237" class="linenr"> 237</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</div>
<div class="pre"><a id="l238" href="#l238" class="linenr"> 238</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;A&nbsp;create_tid&nbsp;of&nbsp;zero&nbsp;indicates&nbsp;a&nbsp;record&nbsp;which&nbsp;is&nbsp;undeletable</div>
<div class="pre"><a id="l239" href="#l239" class="linenr"> 239</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;must&nbsp;be&nbsp;considered&nbsp;to&nbsp;have&nbsp;a&nbsp;value&nbsp;of&nbsp;positive&nbsp;infinity.</div>
<div class="pre"><a id="l240" href="#l240" class="linenr"> 240</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</div>
<div class="pre"><a id="l241" href="#l241" class="linenr"> 241</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key1-&gt;create_tid&nbsp;==&nbsp;0)&nbsp;{</div>
<div class="pre"><a id="l242" href="#l242" class="linenr"> 242</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key2-&gt;create_tid&nbsp;==&nbsp;0)</div>
<div class="pre"><a id="l243" href="#l243" class="linenr"> 243</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(0);</div>
<div class="pre"><a id="l244" href="#l244" class="linenr"> 244</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(1);</div>
<div class="pre"><a id="l245" href="#l245" class="linenr"> 245</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l246" href="#l246" class="linenr"> 246</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key2-&gt;create_tid&nbsp;==&nbsp;0)</div>
<div class="pre"><a id="l247" href="#l247" class="linenr"> 247</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(-1);</div>
<div class="pre"><a id="l248" href="#l248" class="linenr"> 248</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key1-&gt;create_tid&nbsp;&lt;&nbsp;key2-&gt;create_tid)</div>
<div class="pre"><a id="l249" href="#l249" class="linenr"> 249</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(-1);</div>
<div class="pre"><a id="l250" href="#l250" class="linenr"> 250</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key1-&gt;create_tid&nbsp;&gt;&nbsp;key2-&gt;create_tid)</div>
<div class="pre"><a id="l251" href="#l251" class="linenr"> 251</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(1);</div>
<div class="pre"><a id="l252" href="#l252" class="linenr"> 252</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(0);</div>
<div class="pre"><a id="l253" href="#l253" class="linenr"> 253</a> }</div>
<div class="pre"><a id="l254" href="#l254" class="linenr"> 254</a> </div>
<div class="pre"><a id="l255" href="#l255" class="linenr"> 255</a> /*</div>
<div class="pre"><a id="l256" href="#l256" class="linenr"> 256</a> &nbsp;*&nbsp;Heuristical&nbsp;search&nbsp;for&nbsp;the&nbsp;first&nbsp;element&nbsp;whos&nbsp;comparison&nbsp;is&nbsp;&lt;=&nbsp;1.&nbsp;&nbsp;May</div>
<div class="pre"><a id="l257" href="#l257" class="linenr"> 257</a> &nbsp;*&nbsp;return&nbsp;an&nbsp;index&nbsp;whos&nbsp;compare&nbsp;result&nbsp;is&nbsp;&gt;&nbsp;1&nbsp;but&nbsp;may&nbsp;only&nbsp;return&nbsp;an&nbsp;index</div>
<div class="pre"><a id="l258" href="#l258" class="linenr"> 258</a> &nbsp;*&nbsp;whos&nbsp;compare&nbsp;result&nbsp;is&nbsp;&lt;=&nbsp;1&nbsp;if&nbsp;it&nbsp;is&nbsp;the&nbsp;first&nbsp;element&nbsp;with&nbsp;that&nbsp;result.</div>
<div class="pre"><a id="l259" href="#l259" class="linenr"> 259</a> &nbsp;*/</div>
<div class="pre"><a id="l260" href="#l260" class="linenr"> 260</a> static&nbsp;int</div>
<div class="pre"><a id="l261" href="#l261" class="linenr"> 261</a> hammer_btree_search_node(hammer_base_elm_t&nbsp;elm,&nbsp;hammer_node_ondisk_t&nbsp;node)</div>
<div class="pre"><a id="l262" href="#l262" class="linenr"> 262</a> {</div>
<div class="pre"><a id="l263" href="#l263" class="linenr"> 263</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;b;</div>
<div class="pre"><a id="l264" href="#l264" class="linenr"> 264</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;s;</div>
<div class="pre"><a id="l265" href="#l265" class="linenr"> 265</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;i;</div>
<div class="pre"><a id="l266" href="#l266" class="linenr"> 266</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;r;</div>
<div class="pre"><a id="l267" href="#l267" class="linenr"> 267</a> </div>
<div class="pre"><a id="l268" href="#l268" class="linenr"> 268</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</div>
<div class="pre"><a id="l269" href="#l269" class="linenr"> 269</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Don't&nbsp;bother&nbsp;if&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;very&nbsp;many&nbsp;elements</div>
<div class="pre"><a id="l270" href="#l270" class="linenr"> 270</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</div>
<div class="pre"><a id="l271" href="#l271" class="linenr"> 271</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l272" href="#l272" class="linenr"> 272</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;node-&gt;count;</div>
<div class="pre"><a id="l273" href="#l273" class="linenr"> 273</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(s&nbsp;-&nbsp;b&nbsp;&gt;&nbsp;4)&nbsp;{</div>
<div class="pre"><a id="l274" href="#l274" class="linenr"> 274</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;=&nbsp;b&nbsp;+&nbsp;(s&nbsp;-&nbsp;b)&nbsp;/&nbsp;2;</div>
<div class="pre"><a id="l275" href="#l275" class="linenr"> 275</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r&nbsp;=&nbsp;hammer_btree_cmp(elm,&nbsp;&amp;node-&gt;elms[i].leaf.base);</div>
<div class="pre"><a id="l276" href="#l276" class="linenr"> 276</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(r&nbsp;&lt;=&nbsp;1)&nbsp;{</div>
<div class="pre"><a id="l277" href="#l277" class="linenr"> 277</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;i;</div>
<div class="pre"><a id="l278" href="#l278" class="linenr"> 278</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</div>
<div class="pre"><a id="l279" href="#l279" class="linenr"> 279</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;i;</div>
<div class="pre"><a id="l280" href="#l280" class="linenr"> 280</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l281" href="#l281" class="linenr"> 281</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l282" href="#l282" class="linenr"> 282</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(b);</div>
<div class="pre"><a id="l283" href="#l283" class="linenr"> 283</a> }</div>
<div class="pre"><a id="l284" href="#l284" class="linenr"> 284</a> </div>
<div class="pre"><a id="l285" href="#l285" class="linenr"> 285</a> #if&nbsp;0</div>
<div class="pre"><a id="l286" href="#l286" class="linenr"> 286</a> /*</div>
<div class="pre"><a id="l287" href="#l287" class="linenr"> 287</a> &nbsp;*&nbsp;(from&nbsp;hammer_subs.c)</div>
<div class="pre"><a id="l288" href="#l288" class="linenr"> 288</a> &nbsp;*</div>
<div class="pre"><a id="l289" href="#l289" class="linenr"> 289</a> &nbsp;*&nbsp;Return&nbsp;a&nbsp;namekey&nbsp;hash.&nbsp;&nbsp;&nbsp;The&nbsp;64&nbsp;bit&nbsp;namekey&nbsp;hash&nbsp;consists&nbsp;of&nbsp;a&nbsp;32&nbsp;bit</div>
<div class="pre"><a id="l290" href="#l290" class="linenr"> 290</a> &nbsp;*&nbsp;crc&nbsp;in&nbsp;the&nbsp;MSB&nbsp;and&nbsp;0&nbsp;in&nbsp;the&nbsp;LSB.&nbsp;&nbsp;The&nbsp;caller&nbsp;will&nbsp;use&nbsp;the&nbsp;low&nbsp;bits&nbsp;to</div>
<div class="pre"><a id="l291" href="#l291" class="linenr"> 291</a> &nbsp;*&nbsp;generate&nbsp;a&nbsp;unique&nbsp;key&nbsp;and&nbsp;will&nbsp;scan&nbsp;all&nbsp;entries&nbsp;with&nbsp;the&nbsp;same&nbsp;upper</div>
<div class="pre"><a id="l292" href="#l292" class="linenr"> 292</a> &nbsp;*&nbsp;32&nbsp;bits&nbsp;when&nbsp;issuing&nbsp;a&nbsp;lookup.</div>
<div class="pre"><a id="l293" href="#l293" class="linenr"> 293</a> &nbsp;*</div>
<div class="pre"><a id="l294" href="#l294" class="linenr"> 294</a> &nbsp;*&nbsp;We&nbsp;strip&nbsp;bit&nbsp;63&nbsp;in&nbsp;order&nbsp;to&nbsp;provide&nbsp;a&nbsp;positive&nbsp;key,&nbsp;this&nbsp;way&nbsp;a&nbsp;seek</div>
<div class="pre"><a id="l295" href="#l295" class="linenr"> 295</a> &nbsp;*&nbsp;offset&nbsp;of&nbsp;0&nbsp;will&nbsp;represent&nbsp;the&nbsp;base&nbsp;of&nbsp;the&nbsp;directory.</div>
<div class="pre"><a id="l296" href="#l296" class="linenr"> 296</a> &nbsp;*</div>
<div class="pre"><a id="l297" href="#l297" class="linenr"> 297</a> &nbsp;*&nbsp;This&nbsp;function&nbsp;can&nbsp;never&nbsp;return&nbsp;0.&nbsp;&nbsp;We&nbsp;use&nbsp;the&nbsp;MSB-0&nbsp;space&nbsp;to&nbsp;synthesize</div>
<div class="pre"><a id="l298" href="#l298" class="linenr"> 298</a> &nbsp;*&nbsp;artificial&nbsp;directory&nbsp;entries&nbsp;such&nbsp;as&nbsp;&quot;.&quot;&nbsp;and&nbsp;&quot;..&quot;.</div>
<div class="pre"><a id="l299" href="#l299" class="linenr"> 299</a> &nbsp;*/</div>
<div class="pre"><a id="l300" href="#l300" class="linenr"> 300</a> static&nbsp;int64_t</div>
<div class="pre"><a id="l301" href="#l301" class="linenr"> 301</a> hammer_directory_namekey(const&nbsp;void&nbsp;*name,&nbsp;int&nbsp;len)</div>
<div class="pre"><a id="l302" href="#l302" class="linenr"> 302</a> {</div>
<div class="pre"><a id="l303" href="#l303" class="linenr"> 303</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;key;</div>
<div class="pre"><a id="l304" href="#l304" class="linenr"> 304</a> </div>
<div class="pre"><a id="l305" href="#l305" class="linenr"> 305</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key&nbsp;=&nbsp;(int64_t)(crc32(name,&nbsp;len)&nbsp;&amp;&nbsp;0x7FFFFFFF)&nbsp;&lt;&lt;&nbsp;32;</div>
<div class="pre"><a id="l306" href="#l306" class="linenr"> 306</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key&nbsp;==&nbsp;0)</div>
<div class="pre"><a id="l307" href="#l307" class="linenr"> 307</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key&nbsp;|=&nbsp;0x100000000LL;</div>
<div class="pre"><a id="l308" href="#l308" class="linenr"> 308</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(key);</div>
<div class="pre"><a id="l309" href="#l309" class="linenr"> 309</a> }</div>
<div class="pre"><a id="l310" href="#l310" class="linenr"> 310</a> #else</div>
<div class="pre"><a id="l311" href="#l311" class="linenr"> 311</a> static&nbsp;int64_t</div>
<div class="pre"><a id="l312" href="#l312" class="linenr"> 312</a> hammer_directory_namekey(const&nbsp;void&nbsp;*name&nbsp;__unused,&nbsp;int&nbsp;len&nbsp;__unused)</div>
<div class="pre"><a id="l313" href="#l313" class="linenr"> 313</a> {</div>
<div class="pre"><a id="l314" href="#l314" class="linenr"> 314</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(0);</div>
<div class="pre"><a id="l315" href="#l315" class="linenr"> 315</a> }</div>
<div class="pre"><a id="l316" href="#l316" class="linenr"> 316</a> #endif</div>
<div class="pre"><a id="l317" href="#l317" class="linenr"> 317</a> </div>
<div class="pre"><a id="l318" href="#l318" class="linenr"> 318</a> </div>
<div class="pre"><a id="l319" href="#l319" class="linenr"> 319</a> #ifndef&nbsp;BOOT2</div>
<div class="pre"><a id="l320" href="#l320" class="linenr"> 320</a> /*</div>
<div class="pre"><a id="l321" href="#l321" class="linenr"> 321</a> &nbsp;*&nbsp;Misc</div>
<div class="pre"><a id="l322" href="#l322" class="linenr"> 322</a> &nbsp;*/</div>
<div class="pre"><a id="l323" href="#l323" class="linenr"> 323</a> static&nbsp;u_int32_t</div>
<div class="pre"><a id="l324" href="#l324" class="linenr"> 324</a> hammer_to_unix_xid(uuid_t&nbsp;*uuid)</div>
<div class="pre"><a id="l325" href="#l325" class="linenr"> 325</a> {</div>
<div class="pre"><a id="l326" href="#l326" class="linenr"> 326</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(*(u_int32_t&nbsp;*)&amp;uuid-&gt;node[2]);</div>
<div class="pre"><a id="l327" href="#l327" class="linenr"> 327</a> }</div>
<div class="pre"><a id="l328" href="#l328" class="linenr"> 328</a> </div>
<div class="pre"><a id="l329" href="#l329" class="linenr"> 329</a> static&nbsp;int</div>
<div class="pre"><a id="l330" href="#l330" class="linenr"> 330</a> hammer_get_dtype(u_int8_t&nbsp;obj_type)</div>
<div class="pre"><a id="l331" href="#l331" class="linenr"> 331</a> {</div>
<div class="pre"><a id="l332" href="#l332" class="linenr"> 332</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(obj_type)&nbsp;{</div>
<div class="pre"><a id="l333" href="#l333" class="linenr"> 333</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_DIRECTORY:</div>
<div class="pre"><a id="l334" href="#l334" class="linenr"> 334</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(DT_DIR);</div>
<div class="pre"><a id="l335" href="#l335" class="linenr"> 335</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_REGFILE:</div>
<div class="pre"><a id="l336" href="#l336" class="linenr"> 336</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(DT_REG);</div>
<div class="pre"><a id="l337" href="#l337" class="linenr"> 337</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_DBFILE:</div>
<div class="pre"><a id="l338" href="#l338" class="linenr"> 338</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(DT_DBF);</div>
<div class="pre"><a id="l339" href="#l339" class="linenr"> 339</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_FIFO:</div>
<div class="pre"><a id="l340" href="#l340" class="linenr"> 340</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(DT_FIFO);</div>
<div class="pre"><a id="l341" href="#l341" class="linenr"> 341</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_SOCKET:</div>
<div class="pre"><a id="l342" href="#l342" class="linenr"> 342</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(DT_SOCK);</div>
<div class="pre"><a id="l343" href="#l343" class="linenr"> 343</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_CDEV:</div>
<div class="pre"><a id="l344" href="#l344" class="linenr"> 344</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(DT_CHR);</div>
<div class="pre"><a id="l345" href="#l345" class="linenr"> 345</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_BDEV:</div>
<div class="pre"><a id="l346" href="#l346" class="linenr"> 346</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(DT_BLK);</div>
<div class="pre"><a id="l347" href="#l347" class="linenr"> 347</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_SOFTLINK:</div>
<div class="pre"><a id="l348" href="#l348" class="linenr"> 348</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(DT_LNK);</div>
<div class="pre"><a id="l349" href="#l349" class="linenr"> 349</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:</div>
<div class="pre"><a id="l350" href="#l350" class="linenr"> 350</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(DT_UNKNOWN);</div>
<div class="pre"><a id="l351" href="#l351" class="linenr"> 351</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l352" href="#l352" class="linenr"> 352</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;not&nbsp;reached&nbsp;*/</div>
<div class="pre"><a id="l353" href="#l353" class="linenr"> 353</a> }</div>
<div class="pre"><a id="l354" href="#l354" class="linenr"> 354</a> </div>
<div class="pre"><a id="l355" href="#l355" class="linenr"> 355</a> static&nbsp;int</div>
<div class="pre"><a id="l356" href="#l356" class="linenr"> 356</a> hammer_get_mode(u_int8_t&nbsp;obj_type)</div>
<div class="pre"><a id="l357" href="#l357" class="linenr"> 357</a> {</div>
<div class="pre"><a id="l358" href="#l358" class="linenr"> 358</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(obj_type)&nbsp;{</div>
<div class="pre"><a id="l359" href="#l359" class="linenr"> 359</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_DIRECTORY:</div>
<div class="pre"><a id="l360" href="#l360" class="linenr"> 360</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(S_IFDIR);</div>
<div class="pre"><a id="l361" href="#l361" class="linenr"> 361</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_REGFILE:</div>
<div class="pre"><a id="l362" href="#l362" class="linenr"> 362</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(S_IFREG);</div>
<div class="pre"><a id="l363" href="#l363" class="linenr"> 363</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_DBFILE:</div>
<div class="pre"><a id="l364" href="#l364" class="linenr"> 364</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(S_IFDB);</div>
<div class="pre"><a id="l365" href="#l365" class="linenr"> 365</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_FIFO:</div>
<div class="pre"><a id="l366" href="#l366" class="linenr"> 366</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(S_IFIFO);</div>
<div class="pre"><a id="l367" href="#l367" class="linenr"> 367</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_SOCKET:</div>
<div class="pre"><a id="l368" href="#l368" class="linenr"> 368</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(S_IFSOCK);</div>
<div class="pre"><a id="l369" href="#l369" class="linenr"> 369</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_CDEV:</div>
<div class="pre"><a id="l370" href="#l370" class="linenr"> 370</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(S_IFCHR);</div>
<div class="pre"><a id="l371" href="#l371" class="linenr"> 371</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_BDEV:</div>
<div class="pre"><a id="l372" href="#l372" class="linenr"> 372</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(S_IFBLK);</div>
<div class="pre"><a id="l373" href="#l373" class="linenr"> 373</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;HAMMER_OBJTYPE_SOFTLINK:</div>
<div class="pre"><a id="l374" href="#l374" class="linenr"> 374</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(S_IFLNK);</div>
<div class="pre"><a id="l375" href="#l375" class="linenr"> 375</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:</div>
<div class="pre"><a id="l376" href="#l376" class="linenr"> 376</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(0);</div>
<div class="pre"><a id="l377" href="#l377" class="linenr"> 377</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l378" href="#l378" class="linenr"> 378</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;not&nbsp;reached&nbsp;*/</div>
<div class="pre"><a id="l379" href="#l379" class="linenr"> 379</a> }</div>
<div class="pre"><a id="l380" href="#l380" class="linenr"> 380</a> </div>
<div class="pre"><a id="l381" href="#l381" class="linenr"> 381</a> #if&nbsp;DEBUG&nbsp;&gt;&nbsp;1</div>
<div class="pre"><a id="l382" href="#l382" class="linenr"> 382</a> static&nbsp;void</div>
<div class="pre"><a id="l383" href="#l383" class="linenr"> 383</a> hprintb(hammer_base_elm_t&nbsp;e)</div>
<div class="pre"><a id="l384" href="#l384" class="linenr"> 384</a> {</div>
<div class="pre"><a id="l385" href="#l385" class="linenr"> 385</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%d/&quot;,&nbsp;e-&gt;localization);</div>
<div class="pre"><a id="l386" href="#l386" class="linenr"> 386</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(e-&gt;obj_id&nbsp;&gt;&gt;&nbsp;32&nbsp;!=&nbsp;0)</div>
<div class="pre"><a id="l387" href="#l387" class="linenr"> 387</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%lx%08lx&quot;,</div>
<div class="pre"><a id="l388" href="#l388" class="linenr"> 388</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(long)(e-&gt;obj_id&nbsp;&gt;&gt;&nbsp;32),</div>
<div class="pre"><a id="l389" href="#l389" class="linenr"> 389</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(long)(e-&gt;obj_id&nbsp;&amp;&nbsp;0xffffffff));</div>
<div class="pre"><a id="l390" href="#l390" class="linenr"> 390</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</div>
<div class="pre"><a id="l391" href="#l391" class="linenr"> 391</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%lx&quot;,&nbsp;(long)e-&gt;obj_id);</div>
<div class="pre"><a id="l392" href="#l392" class="linenr"> 392</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;/%d/&quot;,&nbsp;e-&gt;rec_type);</div>
<div class="pre"><a id="l393" href="#l393" class="linenr"> 393</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(e-&gt;key&nbsp;&gt;&gt;&nbsp;32&nbsp;!=&nbsp;0)</div>
<div class="pre"><a id="l394" href="#l394" class="linenr"> 394</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%lx%08lx&quot;,</div>
<div class="pre"><a id="l395" href="#l395" class="linenr"> 395</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(long)(e-&gt;key&nbsp;&gt;&gt;&nbsp;32),</div>
<div class="pre"><a id="l396" href="#l396" class="linenr"> 396</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(long)(e-&gt;key&nbsp;&amp;&nbsp;0xffffffff));</div>
<div class="pre"><a id="l397" href="#l397" class="linenr"> 397</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</div>
<div class="pre"><a id="l398" href="#l398" class="linenr"> 398</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%lx&quot;,&nbsp;(long)e-&gt;key);</div>
<div class="pre"><a id="l399" href="#l399" class="linenr"> 399</a> #ifdef&nbsp;TESTING</div>
<div class="pre"><a id="l400" href="#l400" class="linenr"> 400</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;/%llx/%llx&quot;,&nbsp;e-&gt;create_tid,&nbsp;e-&gt;delete_tid);</div>
<div class="pre"><a id="l401" href="#l401" class="linenr"> 401</a> #endif</div>
<div class="pre"><a id="l402" href="#l402" class="linenr"> 402</a> }</div>
<div class="pre"><a id="l403" href="#l403" class="linenr"> 403</a> #endif&nbsp;/*&nbsp;DEBUG&nbsp;&gt;&nbsp;1&nbsp;*/</div>
<div class="pre"><a id="l404" href="#l404" class="linenr"> 404</a> #endif&nbsp;/*&nbsp;!BOOT2&nbsp;*/</div>
<div class="pre"><a id="l405" href="#l405" class="linenr"> 405</a> </div>
<div class="pre"><a id="l406" href="#l406" class="linenr"> 406</a> static&nbsp;hammer_btree_leaf_elm_t</div>
<div class="pre"><a id="l407" href="#l407" class="linenr"> 407</a> hfind(struct&nbsp;hfs&nbsp;*hfs,&nbsp;hammer_base_elm_t&nbsp;key,&nbsp;hammer_base_elm_t&nbsp;end)</div>
<div class="pre"><a id="l408" href="#l408" class="linenr"> 408</a> {</div>
<div class="pre"><a id="l409" href="#l409" class="linenr"> 409</a> #if&nbsp;DEBUG&nbsp;&gt;&nbsp;1</div>
<div class="pre"><a id="l410" href="#l410" class="linenr"> 410</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;searching&nbsp;for&nbsp;&quot;);</div>
<div class="pre"><a id="l411" href="#l411" class="linenr"> 411</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hprintb(key);</div>
<div class="pre"><a id="l412" href="#l412" class="linenr"> 412</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;&nbsp;end&nbsp;&quot;);</div>
<div class="pre"><a id="l413" href="#l413" class="linenr"> 413</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hprintb(end);</div>
<div class="pre"><a id="l414" href="#l414" class="linenr"> 414</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;\n&quot;);</div>
<div class="pre"><a id="l415" href="#l415" class="linenr"> 415</a> #endif</div>
<div class="pre"><a id="l416" href="#l416" class="linenr"> 416</a> </div>
<div class="pre"><a id="l417" href="#l417" class="linenr"> 417</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;n;</div>
<div class="pre"><a id="l418" href="#l418" class="linenr"> 418</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;r;</div>
<div class="pre"><a id="l419" href="#l419" class="linenr"> 419</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hammer_base_elm&nbsp;search&nbsp;=&nbsp;*key;</div>
<div class="pre"><a id="l420" href="#l420" class="linenr"> 420</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hammer_base_elm&nbsp;backtrack;</div>
<div class="pre"><a id="l421" href="#l421" class="linenr"> 421</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_off_t&nbsp;nodeoff&nbsp;=&nbsp;hfs-&gt;root;</div>
<div class="pre"><a id="l422" href="#l422" class="linenr"> 422</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_node_ondisk_t&nbsp;node;</div>
<div class="pre"><a id="l423" href="#l423" class="linenr"> 423</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_btree_elm_t&nbsp;e&nbsp;=&nbsp;NULL;</div>
<div class="pre"><a id="l424" href="#l424" class="linenr"> 424</a> </div>
<div class="pre"><a id="l425" href="#l425" class="linenr"> 425</a> loop:</div>
<div class="pre"><a id="l426" href="#l426" class="linenr"> 426</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node&nbsp;=&nbsp;hread(hfs,&nbsp;nodeoff);</div>
<div class="pre"><a id="l427" href="#l427" class="linenr"> 427</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(node&nbsp;==&nbsp;NULL)</div>
<div class="pre"><a id="l428" href="#l428" class="linenr"> 428</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(NULL);</div>
<div class="pre"><a id="l429" href="#l429" class="linenr"> 429</a> </div>
<div class="pre"><a id="l430" href="#l430" class="linenr"> 430</a> #if&nbsp;DEBUG&nbsp;&gt;&nbsp;3</div>
<div class="pre"><a id="l431" href="#l431" class="linenr"> 431</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;node-&gt;count;&nbsp;i++)&nbsp;{</div>
<div class="pre"><a id="l432" href="#l432" class="linenr"> 432</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;E:&nbsp;&quot;);</div>
<div class="pre"><a id="l433" href="#l433" class="linenr"> 433</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hprintb(&amp;node-&gt;elms[i].base);</div>
<div class="pre"><a id="l434" href="#l434" class="linenr"> 434</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;\n&quot;);</div>
<div class="pre"><a id="l435" href="#l435" class="linenr"> 435</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l436" href="#l436" class="linenr"> 436</a> #endif</div>
<div class="pre"><a id="l437" href="#l437" class="linenr"> 437</a> </div>
<div class="pre"><a id="l438" href="#l438" class="linenr"> 438</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;=&nbsp;hammer_btree_search_node(&amp;search,&nbsp;node);</div>
<div class="pre"><a id="l439" href="#l439" class="linenr"> 439</a> </div>
<div class="pre"><a id="l440" href="#l440" class="linenr"> 440</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(;&nbsp;n&nbsp;&lt;&nbsp;node-&gt;count;&nbsp;n++)&nbsp;{</div>
<div class="pre"><a id="l441" href="#l441" class="linenr"> 441</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e&nbsp;=&nbsp;&amp;node-&gt;elms[n];</div>
<div class="pre"><a id="l442" href="#l442" class="linenr"> 442</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r&nbsp;=&nbsp;hammer_btree_cmp(&amp;search,&nbsp;&amp;e-&gt;base);</div>
<div class="pre"><a id="l443" href="#l443" class="linenr"> 443</a> </div>
<div class="pre"><a id="l444" href="#l444" class="linenr"> 444</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(r&nbsp;&lt;&nbsp;0)</div>
<div class="pre"><a id="l445" href="#l445" class="linenr"> 445</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</div>
<div class="pre"><a id="l446" href="#l446" class="linenr"> 446</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l447" href="#l447" class="linenr"> 447</a> </div>
<div class="pre"><a id="l448" href="#l448" class="linenr"> 448</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;unless&nbsp;we&nbsp;stopped&nbsp;right&nbsp;on&nbsp;the&nbsp;left&nbsp;side,&nbsp;we&nbsp;need&nbsp;to&nbsp;back&nbsp;off&nbsp;a&nbsp;bit</div>
<div class="pre"><a id="l449" href="#l449" class="linenr"> 449</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(n&nbsp;&gt;&nbsp;0)</div>
<div class="pre"><a id="l450" href="#l450" class="linenr"> 450</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e&nbsp;=&nbsp;&amp;node-&gt;elms[n&nbsp;-&nbsp;1];</div>
<div class="pre"><a id="l451" href="#l451" class="linenr"> 451</a> </div>
<div class="pre"><a id="l452" href="#l452" class="linenr"> 452</a> #if&nbsp;DEBUG&nbsp;&gt;&nbsp;2</div>
<div class="pre"><a id="l453" href="#l453" class="linenr"> 453</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;&nbsp;&nbsp;found:&nbsp;&quot;);</div>
<div class="pre"><a id="l454" href="#l454" class="linenr"> 454</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hprintb(&amp;e-&gt;base);</div>
<div class="pre"><a id="l455" href="#l455" class="linenr"> 455</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;\n&quot;);</div>
<div class="pre"><a id="l456" href="#l456" class="linenr"> 456</a> #endif</div>
<div class="pre"><a id="l457" href="#l457" class="linenr"> 457</a> </div>
<div class="pre"><a id="l458" href="#l458" class="linenr"> 458</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(node-&gt;type&nbsp;==&nbsp;HAMMER_BTREE_TYPE_INTERNAL)&nbsp;{</div>
<div class="pre"><a id="l459" href="#l459" class="linenr"> 459</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodeoff&nbsp;=&nbsp;e-&gt;internal.subtree_offset;</div>
<div class="pre"><a id="l460" href="#l460" class="linenr"> 460</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;backtrack&nbsp;=&nbsp;(e+1)-&gt;base;</div>
<div class="pre"><a id="l461" href="#l461" class="linenr"> 461</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;loop;</div>
<div class="pre"><a id="l462" href="#l462" class="linenr"> 462</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l463" href="#l463" class="linenr"> 463</a> </div>
<div class="pre"><a id="l464" href="#l464" class="linenr"> 464</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r&nbsp;=&nbsp;hammer_btree_cmp(key,&nbsp;&amp;e-&gt;base);</div>
<div class="pre"><a id="l465" href="#l465" class="linenr"> 465</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;If&nbsp;we're&nbsp;more&nbsp;off&nbsp;than&nbsp;the&nbsp;createtid,&nbsp;take&nbsp;the&nbsp;next&nbsp;elem</div>
<div class="pre"><a id="l466" href="#l466" class="linenr"> 466</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(r&nbsp;&gt;&nbsp;1)&nbsp;{</div>
<div class="pre"><a id="l467" href="#l467" class="linenr"> 467</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e++;</div>
<div class="pre"><a id="l468" href="#l468" class="linenr"> 468</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n++;</div>
<div class="pre"><a id="l469" href="#l469" class="linenr"> 469</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l470" href="#l470" class="linenr"> 470</a> </div>
<div class="pre"><a id="l471" href="#l471" class="linenr"> 471</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Skip&nbsp;deleted&nbsp;elements</div>
<div class="pre"><a id="l472" href="#l472" class="linenr"> 472</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(n&nbsp;&lt;=&nbsp;node-&gt;count&nbsp;&amp;&amp;&nbsp;e-&gt;base.delete_tid&nbsp;!=&nbsp;0)&nbsp;{</div>
<div class="pre"><a id="l473" href="#l473" class="linenr"> 473</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e++;</div>
<div class="pre"><a id="l474" href="#l474" class="linenr"> 474</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n++;</div>
<div class="pre"><a id="l475" href="#l475" class="linenr"> 475</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l476" href="#l476" class="linenr"> 476</a> </div>
<div class="pre"><a id="l477" href="#l477" class="linenr"> 477</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;In&nbsp;the&nbsp;unfortunate&nbsp;event&nbsp;when&nbsp;there&nbsp;is&nbsp;no&nbsp;next</div>
<div class="pre"><a id="l478" href="#l478" class="linenr"> 478</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;element&nbsp;in&nbsp;this&nbsp;node,&nbsp;we&nbsp;repeat&nbsp;the&nbsp;search&nbsp;with</div>
<div class="pre"><a id="l479" href="#l479" class="linenr"> 479</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;a&nbsp;key&nbsp;beyond&nbsp;the&nbsp;right&nbsp;boundary</div>
<div class="pre"><a id="l480" href="#l480" class="linenr"> 480</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(n&nbsp;&gt;&nbsp;node-&gt;count)&nbsp;{</div>
<div class="pre"><a id="l481" href="#l481" class="linenr"> 481</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;search&nbsp;=&nbsp;backtrack;</div>
<div class="pre"><a id="l482" href="#l482" class="linenr"> 482</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodeoff&nbsp;=&nbsp;hfs-&gt;root;</div>
<div class="pre"><a id="l483" href="#l483" class="linenr"> 483</a> </div>
<div class="pre"><a id="l484" href="#l484" class="linenr"> 484</a> #if&nbsp;DEBUG&nbsp;&gt;&nbsp;2</div>
<div class="pre"><a id="l485" href="#l485" class="linenr"> 485</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;hit&nbsp;right&nbsp;boundary&nbsp;(%d),&nbsp;resetting&nbsp;search&nbsp;to&nbsp;&quot;,</div>
<div class="pre"><a id="l486" href="#l486" class="linenr"> 486</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node-&gt;count);</div>
<div class="pre"><a id="l487" href="#l487" class="linenr"> 487</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hprintb(&amp;search);</div>
<div class="pre"><a id="l488" href="#l488" class="linenr"> 488</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;\n&quot;);</div>
<div class="pre"><a id="l489" href="#l489" class="linenr"> 489</a> #endif</div>
<div class="pre"><a id="l490" href="#l490" class="linenr"> 490</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;loop;</div>
<div class="pre"><a id="l491" href="#l491" class="linenr"> 491</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l492" href="#l492" class="linenr"> 492</a> </div>
<div class="pre"><a id="l493" href="#l493" class="linenr"> 493</a> #if&nbsp;DEBUG&nbsp;&gt;&nbsp;1</div>
<div class="pre"><a id="l494" href="#l494" class="linenr"> 494</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;&nbsp;&nbsp;result:&nbsp;&quot;);</div>
<div class="pre"><a id="l495" href="#l495" class="linenr"> 495</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hprintb(&amp;e-&gt;base);</div>
<div class="pre"><a id="l496" href="#l496" class="linenr"> 496</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;\n&quot;);</div>
<div class="pre"><a id="l497" href="#l497" class="linenr"> 497</a> #endif</div>
<div class="pre"><a id="l498" href="#l498" class="linenr"> 498</a> </div>
<div class="pre"><a id="l499" href="#l499" class="linenr"> 499</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(end&nbsp;!=&nbsp;NULL)</div>
<div class="pre"><a id="l500" href="#l500" class="linenr"> 500</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hammer_btree_cmp(end,&nbsp;&amp;e-&gt;base)&nbsp;&lt;&nbsp;-1)</div>
<div class="pre"><a id="l501" href="#l501" class="linenr"> 501</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;fail;</div>
<div class="pre"><a id="l502" href="#l502" class="linenr"> 502</a> </div>
<div class="pre"><a id="l503" href="#l503" class="linenr"> 503</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(&amp;e-&gt;leaf);</div>
<div class="pre"><a id="l504" href="#l504" class="linenr"> 504</a> </div>
<div class="pre"><a id="l505" href="#l505" class="linenr"> 505</a> fail:</div>
<div class="pre"><a id="l506" href="#l506" class="linenr"> 506</a> #if&nbsp;DEBUG&nbsp;&gt;&nbsp;1</div>
<div class="pre"><a id="l507" href="#l507" class="linenr"> 507</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;&nbsp;&nbsp;fail.\n&quot;);</div>
<div class="pre"><a id="l508" href="#l508" class="linenr"> 508</a> #endif</div>
<div class="pre"><a id="l509" href="#l509" class="linenr"> 509</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(NULL);</div>
<div class="pre"><a id="l510" href="#l510" class="linenr"> 510</a> }</div>
<div class="pre"><a id="l511" href="#l511" class="linenr"> 511</a> </div>
<div class="pre"><a id="l512" href="#l512" class="linenr"> 512</a> #ifndef&nbsp;BOOT2</div>
<div class="pre"><a id="l513" href="#l513" class="linenr"> 513</a> static&nbsp;int</div>
<div class="pre"><a id="l514" href="#l514" class="linenr"> 514</a> hreaddir(struct&nbsp;hfs&nbsp;*hfs,&nbsp;ino_t&nbsp;ino,&nbsp;int64_t&nbsp;*off,&nbsp;struct&nbsp;dirent&nbsp;*de)</div>
<div class="pre"><a id="l515" href="#l515" class="linenr"> 515</a> {</div>
<div class="pre"><a id="l516" href="#l516" class="linenr"> 516</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hammer_base_elm&nbsp;key,&nbsp;end;</div>
<div class="pre"><a id="l517" href="#l517" class="linenr"> 517</a> </div>
<div class="pre"><a id="l518" href="#l518" class="linenr"> 518</a> #if&nbsp;DEBUG&nbsp;&gt;&nbsp;2</div>
<div class="pre"><a id="l519" href="#l519" class="linenr"> 519</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%s(%llx,&nbsp;%lld)\n&quot;,&nbsp;__FUNCTION__,&nbsp;(long&nbsp;long)ino,&nbsp;*off);</div>
<div class="pre"><a id="l520" href="#l520" class="linenr"> 520</a> #endif</div>
<div class="pre"><a id="l521" href="#l521" class="linenr"> 521</a> </div>
<div class="pre"><a id="l522" href="#l522" class="linenr"> 522</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bzero(&amp;key,&nbsp;sizeof(key));</div>
<div class="pre"><a id="l523" href="#l523" class="linenr"> 523</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.obj_id&nbsp;=&nbsp;ino;</div>
<div class="pre"><a id="l524" href="#l524" class="linenr"> 524</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.localization&nbsp;=&nbsp;HAMMER_LOCALIZE_MISC;</div>
<div class="pre"><a id="l525" href="#l525" class="linenr"> 525</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.rec_type&nbsp;=&nbsp;HAMMER_RECTYPE_DIRENTRY;</div>
<div class="pre"><a id="l526" href="#l526" class="linenr"> 526</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.key&nbsp;=&nbsp;*off;</div>
<div class="pre"><a id="l527" href="#l527" class="linenr"> 527</a> </div>
<div class="pre"><a id="l528" href="#l528" class="linenr"> 528</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end&nbsp;=&nbsp;key;</div>
<div class="pre"><a id="l529" href="#l529" class="linenr"> 529</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end.key&nbsp;=&nbsp;HAMMER_MAX_KEY;</div>
<div class="pre"><a id="l530" href="#l530" class="linenr"> 530</a> </div>
<div class="pre"><a id="l531" href="#l531" class="linenr"> 531</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_btree_leaf_elm_t&nbsp;e;</div>
<div class="pre"><a id="l532" href="#l532" class="linenr"> 532</a> </div>
<div class="pre"><a id="l533" href="#l533" class="linenr"> 533</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e&nbsp;=&nbsp;hfind(hfs,&nbsp;&amp;key,&nbsp;&amp;end);</div>
<div class="pre"><a id="l534" href="#l534" class="linenr"> 534</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(e&nbsp;==&nbsp;NULL)&nbsp;{</div>
<div class="pre"><a id="l535" href="#l535" class="linenr"> 535</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;errno&nbsp;=&nbsp;ENOENT;</div>
<div class="pre"><a id="l536" href="#l536" class="linenr"> 536</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(-1);</div>
<div class="pre"><a id="l537" href="#l537" class="linenr"> 537</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l538" href="#l538" class="linenr"> 538</a> </div>
<div class="pre"><a id="l539" href="#l539" class="linenr"> 539</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*off&nbsp;=&nbsp;e-&gt;base.key&nbsp;+&nbsp;1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;remember&nbsp;next&nbsp;pos</div>
<div class="pre"><a id="l540" href="#l540" class="linenr"> 540</a> </div>
<div class="pre"><a id="l541" href="#l541" class="linenr"> 541</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;de-&gt;d_namlen&nbsp;=&nbsp;e-&gt;data_len&nbsp;-&nbsp;HAMMER_ENTRY_NAME_OFF;</div>
<div class="pre"><a id="l542" href="#l542" class="linenr"> 542</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;de-&gt;d_type&nbsp;=&nbsp;hammer_get_dtype(e-&gt;base.obj_type);</div>
<div class="pre"><a id="l543" href="#l543" class="linenr"> 543</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_data_ondisk_t&nbsp;ed&nbsp;=&nbsp;hread(hfs,&nbsp;e-&gt;data_offset);</div>
<div class="pre"><a id="l544" href="#l544" class="linenr"> 544</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ed&nbsp;==&nbsp;NULL)</div>
<div class="pre"><a id="l545" href="#l545" class="linenr"> 545</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(-1);</div>
<div class="pre"><a id="l546" href="#l546" class="linenr"> 546</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;de-&gt;d_ino&nbsp;=&nbsp;ed-&gt;entry.obj_id;</div>
<div class="pre"><a id="l547" href="#l547" class="linenr"> 547</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bcopy(ed-&gt;entry.name,&nbsp;de-&gt;d_name,&nbsp;de-&gt;d_namlen);</div>
<div class="pre"><a id="l548" href="#l548" class="linenr"> 548</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;de-&gt;d_name[de-&gt;d_namlen]&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l549" href="#l549" class="linenr"> 549</a> </div>
<div class="pre"><a id="l550" href="#l550" class="linenr"> 550</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(0);</div>
<div class="pre"><a id="l551" href="#l551" class="linenr"> 551</a> }</div>
<div class="pre"><a id="l552" href="#l552" class="linenr"> 552</a> #endif</div>
<div class="pre"><a id="l553" href="#l553" class="linenr"> 553</a> </div>
<div class="pre"><a id="l554" href="#l554" class="linenr"> 554</a> static&nbsp;ino_t</div>
<div class="pre"><a id="l555" href="#l555" class="linenr"> 555</a> hresolve(struct&nbsp;hfs&nbsp;*hfs,&nbsp;ino_t&nbsp;dirino,&nbsp;const&nbsp;char&nbsp;*name)</div>
<div class="pre"><a id="l556" href="#l556" class="linenr"> 556</a> {</div>
<div class="pre"><a id="l557" href="#l557" class="linenr"> 557</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hammer_base_elm&nbsp;key,&nbsp;end;</div>
<div class="pre"><a id="l558" href="#l558" class="linenr"> 558</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;namel&nbsp;=&nbsp;strlen(name);</div>
<div class="pre"><a id="l559" href="#l559" class="linenr"> 559</a> </div>
<div class="pre"><a id="l560" href="#l560" class="linenr"> 560</a> #if&nbsp;DEBUG&nbsp;&gt;&nbsp;2</div>
<div class="pre"><a id="l561" href="#l561" class="linenr"> 561</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%s(%llx,&nbsp;%s)\n&quot;,&nbsp;__FUNCTION__,&nbsp;(long&nbsp;long)dirino,&nbsp;name);</div>
<div class="pre"><a id="l562" href="#l562" class="linenr"> 562</a> #endif</div>
<div class="pre"><a id="l563" href="#l563" class="linenr"> 563</a> </div>
<div class="pre"><a id="l564" href="#l564" class="linenr"> 564</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bzero(&amp;key,&nbsp;sizeof(key));</div>
<div class="pre"><a id="l565" href="#l565" class="linenr"> 565</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.obj_id&nbsp;=&nbsp;dirino;</div>
<div class="pre"><a id="l566" href="#l566" class="linenr"> 566</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.localization&nbsp;=&nbsp;HAMMER_LOCALIZE_MISC;</div>
<div class="pre"><a id="l567" href="#l567" class="linenr"> 567</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.key&nbsp;=&nbsp;hammer_directory_namekey(name,&nbsp;namel);</div>
<div class="pre"><a id="l568" href="#l568" class="linenr"> 568</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.rec_type&nbsp;=&nbsp;HAMMER_RECTYPE_DIRENTRY;</div>
<div class="pre"><a id="l569" href="#l569" class="linenr"> 569</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end&nbsp;=&nbsp;key;</div>
<div class="pre"><a id="l570" href="#l570" class="linenr"> 570</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end.key&nbsp;=&nbsp;HAMMER_MAX_KEY;</div>
<div class="pre"><a id="l571" href="#l571" class="linenr"> 571</a> </div>
<div class="pre"><a id="l572" href="#l572" class="linenr"> 572</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_btree_leaf_elm_t&nbsp;e;</div>
<div class="pre"><a id="l573" href="#l573" class="linenr"> 573</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;((e&nbsp;=&nbsp;hfind(hfs,&nbsp;&amp;key,&nbsp;&amp;end))&nbsp;!=&nbsp;NULL)&nbsp;{</div>
<div class="pre"><a id="l574" href="#l574" class="linenr"> 574</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.key&nbsp;=&nbsp;e-&gt;base.key&nbsp;+&nbsp;1;</div>
<div class="pre"><a id="l575" href="#l575" class="linenr"> 575</a> </div>
<div class="pre"><a id="l576" href="#l576" class="linenr"> 576</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;elen&nbsp;=&nbsp;e-&gt;data_len&nbsp;-&nbsp;HAMMER_ENTRY_NAME_OFF;</div>
<div class="pre"><a id="l577" href="#l577" class="linenr"> 577</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_data_ondisk_t&nbsp;ed&nbsp;=&nbsp;hread(hfs,&nbsp;e-&gt;data_offset);</div>
<div class="pre"><a id="l578" href="#l578" class="linenr"> 578</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ed&nbsp;==&nbsp;NULL)</div>
<div class="pre"><a id="l579" href="#l579" class="linenr"> 579</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(-1);</div>
<div class="pre"><a id="l580" href="#l580" class="linenr"> 580</a> #ifdef&nbsp;BOOT2</div>
<div class="pre"><a id="l581" href="#l581" class="linenr"> 581</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ls)&nbsp;{</div>
<div class="pre"><a id="l582" href="#l582" class="linenr"> 582</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;elen;&nbsp;i++)</div>
<div class="pre"><a id="l583" href="#l583" class="linenr"> 583</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;putchar(ed-&gt;entry.name[i]);</div>
<div class="pre"><a id="l584" href="#l584" class="linenr"> 584</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;putchar('&nbsp;');</div>
<div class="pre"><a id="l585" href="#l585" class="linenr"> 585</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls&nbsp;=&nbsp;2;</div>
<div class="pre"><a id="l586" href="#l586" class="linenr"> 586</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</div>
<div class="pre"><a id="l587" href="#l587" class="linenr"> 587</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l588" href="#l588" class="linenr"> 588</a> #endif</div>
<div class="pre"><a id="l589" href="#l589" class="linenr"> 589</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(elen&nbsp;==&nbsp;namel&nbsp;&amp;&amp;&nbsp;memcmp(ed-&gt;entry.name,&nbsp;name,&nbsp;MIN(elen,&nbsp;namel))&nbsp;==&nbsp;0)</div>
<div class="pre"><a id="l590" href="#l590" class="linenr"> 590</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(ed-&gt;entry.obj_id);</div>
<div class="pre"><a id="l591" href="#l591" class="linenr"> 591</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l592" href="#l592" class="linenr"> 592</a> </div>
<div class="pre"><a id="l593" href="#l593" class="linenr"> 593</a> #if&nbsp;BOOT2</div>
<div class="pre"><a id="l594" href="#l594" class="linenr"> 594</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ls&nbsp;==&nbsp;2)</div>
<div class="pre"><a id="l595" href="#l595" class="linenr"> 595</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;\n&quot;);</div>
<div class="pre"><a id="l596" href="#l596" class="linenr"> 596</a> #endif</div>
<div class="pre"><a id="l597" href="#l597" class="linenr"> 597</a> </div>
<div class="pre"><a id="l598" href="#l598" class="linenr"> 598</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1;</div>
<div class="pre"><a id="l599" href="#l599" class="linenr"> 599</a> }</div>
<div class="pre"><a id="l600" href="#l600" class="linenr"> 600</a> </div>
<div class="pre"><a id="l601" href="#l601" class="linenr"> 601</a> static&nbsp;ino_t</div>
<div class="pre"><a id="l602" href="#l602" class="linenr"> 602</a> hlookup(struct&nbsp;hfs&nbsp;*hfs,&nbsp;const&nbsp;char&nbsp;*path)</div>
<div class="pre"><a id="l603" href="#l603" class="linenr"> 603</a> {</div>
<div class="pre"><a id="l604" href="#l604" class="linenr"> 604</a> #if&nbsp;DEBUG&nbsp;&gt;&nbsp;2</div>
<div class="pre"><a id="l605" href="#l605" class="linenr"> 605</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%s(%s)\n&quot;,&nbsp;__FUNCTION__,&nbsp;path);</div>
<div class="pre"><a id="l606" href="#l606" class="linenr"> 606</a> #endif</div>
<div class="pre"><a id="l607" href="#l607" class="linenr"> 607</a> </div>
<div class="pre"><a id="l608" href="#l608" class="linenr"> 608</a> #ifdef&nbsp;BOOT2</div>
<div class="pre"><a id="l609" href="#l609" class="linenr"> 609</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l610" href="#l610" class="linenr"> 610</a> #endif</div>
<div class="pre"><a id="l611" href="#l611" class="linenr"> 611</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ino_t&nbsp;ino&nbsp;=&nbsp;1;</div>
<div class="pre"><a id="l612" href="#l612" class="linenr"> 612</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do&nbsp;{</div>
<div class="pre"><a id="l613" href="#l613" class="linenr"> 613</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;name[MAXPATHLEN&nbsp;+&nbsp;1];</div>
<div class="pre"><a id="l614" href="#l614" class="linenr"> 614</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(*path&nbsp;==&nbsp;'/')</div>
<div class="pre"><a id="l615" href="#l615" class="linenr"> 615</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path++;</div>
<div class="pre"><a id="l616" href="#l616" class="linenr"> 616</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(*path&nbsp;==&nbsp;0)</div>
<div class="pre"><a id="l617" href="#l617" class="linenr"> 617</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</div>
<div class="pre"><a id="l618" href="#l618" class="linenr"> 618</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(char&nbsp;*n&nbsp;=&nbsp;name;&nbsp;*path&nbsp;!=&nbsp;0&nbsp;&amp;&amp;&nbsp;*path&nbsp;!=&nbsp;'/';&nbsp;path++,&nbsp;n++)&nbsp;{</div>
<div class="pre"><a id="l619" href="#l619" class="linenr"> 619</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n[0]&nbsp;=&nbsp;*path;</div>
<div class="pre"><a id="l620" href="#l620" class="linenr"> 620</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n[1]&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l621" href="#l621" class="linenr"> 621</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l622" href="#l622" class="linenr"> 622</a> </div>
<div class="pre"><a id="l623" href="#l623" class="linenr"> 623</a> #ifdef&nbsp;BOOT2</div>
<div class="pre"><a id="l624" href="#l624" class="linenr"> 624</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;A&nbsp;single&nbsp;?&nbsp;means&nbsp;&quot;list&quot;</div>
<div class="pre"><a id="l625" href="#l625" class="linenr"> 625</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(name[0]&nbsp;==&nbsp;'?'&nbsp;&amp;&amp;&nbsp;name[1]&nbsp;==&nbsp;0)</div>
<div class="pre"><a id="l626" href="#l626" class="linenr"> 626</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls&nbsp;=&nbsp;1;</div>
<div class="pre"><a id="l627" href="#l627" class="linenr"> 627</a> #endif</div>
<div class="pre"><a id="l628" href="#l628" class="linenr"> 628</a> </div>
<div class="pre"><a id="l629" href="#l629" class="linenr"> 629</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ino&nbsp;=&nbsp;hresolve(hfs,&nbsp;ino,&nbsp;name);</div>
<div class="pre"><a id="l630" href="#l630" class="linenr"> 630</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;while&nbsp;(ino&nbsp;!=&nbsp;(ino_t)-1&nbsp;&amp;&amp;&nbsp;*path&nbsp;!=&nbsp;0);</div>
<div class="pre"><a id="l631" href="#l631" class="linenr"> 631</a> </div>
<div class="pre"><a id="l632" href="#l632" class="linenr"> 632</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(ino);</div>
<div class="pre"><a id="l633" href="#l633" class="linenr"> 633</a> }</div>
<div class="pre"><a id="l634" href="#l634" class="linenr"> 634</a> </div>
<div class="pre"><a id="l635" href="#l635" class="linenr"> 635</a> </div>
<div class="pre"><a id="l636" href="#l636" class="linenr"> 636</a> #ifndef&nbsp;BOOT2</div>
<div class="pre"><a id="l637" href="#l637" class="linenr"> 637</a> static&nbsp;int</div>
<div class="pre"><a id="l638" href="#l638" class="linenr"> 638</a> hstat(struct&nbsp;hfs&nbsp;*hfs,&nbsp;ino_t&nbsp;ino,&nbsp;struct&nbsp;stat*&nbsp;st)</div>
<div class="pre"><a id="l639" href="#l639" class="linenr"> 639</a> {</div>
<div class="pre"><a id="l640" href="#l640" class="linenr"> 640</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hammer_base_elm&nbsp;key;</div>
<div class="pre"><a id="l641" href="#l641" class="linenr"> 641</a> </div>
<div class="pre"><a id="l642" href="#l642" class="linenr"> 642</a> #if&nbsp;DEBUG&nbsp;&gt;&nbsp;2</div>
<div class="pre"><a id="l643" href="#l643" class="linenr"> 643</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%s(%llx)\n&quot;,&nbsp;__FUNCTION__,&nbsp;(long&nbsp;long)ino);</div>
<div class="pre"><a id="l644" href="#l644" class="linenr"> 644</a> #endif</div>
<div class="pre"><a id="l645" href="#l645" class="linenr"> 645</a> </div>
<div class="pre"><a id="l646" href="#l646" class="linenr"> 646</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bzero(&amp;key,&nbsp;sizeof(key));</div>
<div class="pre"><a id="l647" href="#l647" class="linenr"> 647</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.obj_id&nbsp;=&nbsp;ino;</div>
<div class="pre"><a id="l648" href="#l648" class="linenr"> 648</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.localization&nbsp;=&nbsp;HAMMER_LOCALIZE_INODE;</div>
<div class="pre"><a id="l649" href="#l649" class="linenr"> 649</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.rec_type&nbsp;=&nbsp;HAMMER_RECTYPE_INODE;</div>
<div class="pre"><a id="l650" href="#l650" class="linenr"> 650</a> </div>
<div class="pre"><a id="l651" href="#l651" class="linenr"> 651</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_btree_leaf_elm_t&nbsp;e&nbsp;=&nbsp;hfind(hfs,&nbsp;&amp;key,&nbsp;&amp;key);</div>
<div class="pre"><a id="l652" href="#l652" class="linenr"> 652</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(e&nbsp;==&nbsp;NULL)&nbsp;{</div>
<div class="pre"><a id="l653" href="#l653" class="linenr"> 653</a> #ifndef&nbsp;BOOT2</div>
<div class="pre"><a id="l654" href="#l654" class="linenr"> 654</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;errno&nbsp;=&nbsp;ENOENT;</div>
<div class="pre"><a id="l655" href="#l655" class="linenr"> 655</a> #endif</div>
<div class="pre"><a id="l656" href="#l656" class="linenr"> 656</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1;</div>
<div class="pre"><a id="l657" href="#l657" class="linenr"> 657</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l658" href="#l658" class="linenr"> 658</a> </div>
<div class="pre"><a id="l659" href="#l659" class="linenr"> 659</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_data_ondisk_t&nbsp;ed&nbsp;=&nbsp;hread(hfs,&nbsp;e-&gt;data_offset);</div>
<div class="pre"><a id="l660" href="#l660" class="linenr"> 660</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ed&nbsp;==&nbsp;NULL)</div>
<div class="pre"><a id="l661" href="#l661" class="linenr"> 661</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(-1);</div>
<div class="pre"><a id="l662" href="#l662" class="linenr"> 662</a> </div>
<div class="pre"><a id="l663" href="#l663" class="linenr"> 663</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;st-&gt;st_mode&nbsp;=&nbsp;ed-&gt;inode.mode&nbsp;|&nbsp;hammer_get_mode(ed-&gt;inode.obj_type);</div>
<div class="pre"><a id="l664" href="#l664" class="linenr"> 664</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;st-&gt;st_uid&nbsp;=&nbsp;hammer_to_unix_xid(&amp;ed-&gt;inode.uid);</div>
<div class="pre"><a id="l665" href="#l665" class="linenr"> 665</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;st-&gt;st_gid&nbsp;=&nbsp;hammer_to_unix_xid(&amp;ed-&gt;inode.gid);</div>
<div class="pre"><a id="l666" href="#l666" class="linenr"> 666</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;st-&gt;st_size&nbsp;=&nbsp;ed-&gt;inode.size;</div>
<div class="pre"><a id="l667" href="#l667" class="linenr"> 667</a> </div>
<div class="pre"><a id="l668" href="#l668" class="linenr"> 668</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(0);</div>
<div class="pre"><a id="l669" href="#l669" class="linenr"> 669</a> }</div>
<div class="pre"><a id="l670" href="#l670" class="linenr"> 670</a> #endif</div>
<div class="pre"><a id="l671" href="#l671" class="linenr"> 671</a> </div>
<div class="pre"><a id="l672" href="#l672" class="linenr"> 672</a> static&nbsp;ssize_t</div>
<div class="pre"><a id="l673" href="#l673" class="linenr"> 673</a> hreadf(struct&nbsp;hfs&nbsp;*hfs,&nbsp;ino_t&nbsp;ino,&nbsp;int64_t&nbsp;off,&nbsp;int64_t&nbsp;len,&nbsp;char&nbsp;*buf)</div>
<div class="pre"><a id="l674" href="#l674" class="linenr"> 674</a> {</div>
<div class="pre"><a id="l675" href="#l675" class="linenr"> 675</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;startoff&nbsp;=&nbsp;off;</div>
<div class="pre"><a id="l676" href="#l676" class="linenr"> 676</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hammer_base_elm&nbsp;key,&nbsp;end;</div>
<div class="pre"><a id="l677" href="#l677" class="linenr"> 677</a> </div>
<div class="pre"><a id="l678" href="#l678" class="linenr"> 678</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bzero(&amp;key,&nbsp;sizeof(key));</div>
<div class="pre"><a id="l679" href="#l679" class="linenr"> 679</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.obj_id&nbsp;=&nbsp;ino;</div>
<div class="pre"><a id="l680" href="#l680" class="linenr"> 680</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.localization&nbsp;=&nbsp;HAMMER_LOCALIZE_MISC;</div>
<div class="pre"><a id="l681" href="#l681" class="linenr"> 681</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.rec_type&nbsp;=&nbsp;HAMMER_RECTYPE_DATA;</div>
<div class="pre"><a id="l682" href="#l682" class="linenr"> 682</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end&nbsp;=&nbsp;key;</div>
<div class="pre"><a id="l683" href="#l683" class="linenr"> 683</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end.key&nbsp;=&nbsp;HAMMER_MAX_KEY;</div>
<div class="pre"><a id="l684" href="#l684" class="linenr"> 684</a> </div>
<div class="pre"><a id="l685" href="#l685" class="linenr"> 685</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(len&nbsp;&gt;&nbsp;0)&nbsp;{</div>
<div class="pre"><a id="l686" href="#l686" class="linenr"> 686</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key.key&nbsp;=&nbsp;off&nbsp;+&nbsp;1;</div>
<div class="pre"><a id="l687" href="#l687" class="linenr"> 687</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_btree_leaf_elm_t&nbsp;e&nbsp;=&nbsp;hfind(hfs,&nbsp;&amp;key,&nbsp;&amp;end);</div>
<div class="pre"><a id="l688" href="#l688" class="linenr"> 688</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;dlen;</div>
<div class="pre"><a id="l689" href="#l689" class="linenr"> 689</a> </div>
<div class="pre"><a id="l690" href="#l690" class="linenr"> 690</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(e&nbsp;==&nbsp;NULL&nbsp;||&nbsp;off&nbsp;&gt;&nbsp;e-&gt;base.key)&nbsp;{</div>
<div class="pre"><a id="l691" href="#l691" class="linenr"> 691</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bzero(buf,&nbsp;len);</div>
<div class="pre"><a id="l692" href="#l692" class="linenr"> 692</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;off&nbsp;+=&nbsp;len;</div>
<div class="pre"><a id="l693" href="#l693" class="linenr"> 693</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l694" href="#l694" class="linenr"> 694</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</div>
<div class="pre"><a id="l695" href="#l695" class="linenr"> 695</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l696" href="#l696" class="linenr"> 696</a> </div>
<div class="pre"><a id="l697" href="#l697" class="linenr"> 697</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;doff&nbsp;=&nbsp;e-&gt;base.key&nbsp;-&nbsp;e-&gt;data_len;</div>
<div class="pre"><a id="l698" href="#l698" class="linenr"> 698</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(off&nbsp;&lt;&nbsp;doff)&nbsp;{</div>
<div class="pre"><a id="l699" href="#l699" class="linenr"> 699</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;sparse&nbsp;file,&nbsp;beginning</div>
<div class="pre"><a id="l700" href="#l700" class="linenr"> 700</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dlen&nbsp;=&nbsp;doff&nbsp;-&nbsp;off;</div>
<div class="pre"><a id="l701" href="#l701" class="linenr"> 701</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dlen&nbsp;=&nbsp;MIN(dlen,&nbsp;len);</div>
<div class="pre"><a id="l702" href="#l702" class="linenr"> 702</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bzero(buf,&nbsp;dlen);</div>
<div class="pre"><a id="l703" href="#l703" class="linenr"> 703</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</div>
<div class="pre"><a id="l704" href="#l704" class="linenr"> 704</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;boff&nbsp;=&nbsp;off&nbsp;-&nbsp;doff;</div>
<div class="pre"><a id="l705" href="#l705" class="linenr"> 705</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_off_t&nbsp;roff&nbsp;=&nbsp;e-&gt;data_offset;</div>
<div class="pre"><a id="l706" href="#l706" class="linenr"> 706</a> </div>
<div class="pre"><a id="l707" href="#l707" class="linenr"> 707</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dlen&nbsp;=&nbsp;e-&gt;data_len;</div>
<div class="pre"><a id="l708" href="#l708" class="linenr"> 708</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dlen&nbsp;-=&nbsp;boff;</div>
<div class="pre"><a id="l709" href="#l709" class="linenr"> 709</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dlen&nbsp;=&nbsp;MIN(dlen,&nbsp;len);</div>
<div class="pre"><a id="l710" href="#l710" class="linenr"> 710</a> </div>
<div class="pre"><a id="l711" href="#l711" class="linenr"> 711</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(boff&nbsp;&gt;=&nbsp;HAMMER_BUFSIZE)&nbsp;{</div>
<div class="pre"><a id="l712" href="#l712" class="linenr"> 712</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boff&nbsp;-=&nbsp;HAMMER_BUFSIZE;</div>
<div class="pre"><a id="l713" href="#l713" class="linenr"> 713</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;roff&nbsp;+=&nbsp;HAMMER_BUFSIZE;</div>
<div class="pre"><a id="l714" href="#l714" class="linenr"> 714</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l715" href="#l715" class="linenr"> 715</a> </div>
<div class="pre"><a id="l716" href="#l716" class="linenr"> 716</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</div>
<div class="pre"><a id="l717" href="#l717" class="linenr"> 717</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;boff&nbsp;-&nbsp;relative&nbsp;offset&nbsp;in&nbsp;disk&nbsp;buffer&nbsp;(not&nbsp;aligned)</div>
<div class="pre"><a id="l718" href="#l718" class="linenr"> 718</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;roff&nbsp;-&nbsp;base&nbsp;offset&nbsp;of&nbsp;disk&nbsp;buffer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(not&nbsp;aligned)</div>
<div class="pre"><a id="l719" href="#l719" class="linenr"> 719</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;dlen&nbsp;-&nbsp;amount&nbsp;of&nbsp;data&nbsp;we&nbsp;think&nbsp;we&nbsp;can&nbsp;copy</div>
<div class="pre"><a id="l720" href="#l720" class="linenr"> 720</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</div>
<div class="pre"><a id="l721" href="#l721" class="linenr"> 721</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;hread&nbsp;only&nbsp;reads&nbsp;16K&nbsp;aligned&nbsp;buffers,&nbsp;check&nbsp;for</div>
<div class="pre"><a id="l722" href="#l722" class="linenr"> 722</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;a&nbsp;length&nbsp;overflow&nbsp;and&nbsp;truncate&nbsp;dlen&nbsp;appropriately.</div>
<div class="pre"><a id="l723" href="#l723" class="linenr"> 723</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</div>
<div class="pre"><a id="l724" href="#l724" class="linenr"> 724</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((roff&nbsp;&amp;&nbsp;~HAMMER_BUFMASK64)&nbsp;!=&nbsp;((roff&nbsp;+&nbsp;boff&nbsp;+&nbsp;dlen&nbsp;-&nbsp;1)&nbsp;&amp;&nbsp;~HAMMER_BUFMASK64))</div>
<div class="pre"><a id="l725" href="#l725" class="linenr"> 725</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dlen&nbsp;=&nbsp;HAMMER_BUFSIZE&nbsp;-&nbsp;((boff&nbsp;+&nbsp;roff)&nbsp;&amp;&nbsp;HAMMER_BUFMASK);</div>
<div class="pre"><a id="l726" href="#l726" class="linenr"> 726</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;*data&nbsp;=&nbsp;hread(hfs,&nbsp;roff);</div>
<div class="pre"><a id="l727" href="#l727" class="linenr"> 727</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(data&nbsp;==&nbsp;NULL)</div>
<div class="pre"><a id="l728" href="#l728" class="linenr"> 728</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(-1);</div>
<div class="pre"><a id="l729" href="#l729" class="linenr"> 729</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bcopy(data&nbsp;+&nbsp;boff,&nbsp;buf,&nbsp;dlen);</div>
<div class="pre"><a id="l730" href="#l730" class="linenr"> 730</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l731" href="#l731" class="linenr"> 731</a> </div>
<div class="pre"><a id="l732" href="#l732" class="linenr"> 732</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf&nbsp;+=&nbsp;dlen;</div>
<div class="pre"><a id="l733" href="#l733" class="linenr"> 733</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;off&nbsp;+=&nbsp;dlen;</div>
<div class="pre"><a id="l734" href="#l734" class="linenr"> 734</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;-=&nbsp;dlen;</div>
<div class="pre"><a id="l735" href="#l735" class="linenr"> 735</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l736" href="#l736" class="linenr"> 736</a> </div>
<div class="pre"><a id="l737" href="#l737" class="linenr"> 737</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(off&nbsp;-&nbsp;startoff);</div>
<div class="pre"><a id="l738" href="#l738" class="linenr"> 738</a> }</div>
<div class="pre"><a id="l739" href="#l739" class="linenr"> 739</a> </div>
<div class="pre"><a id="l740" href="#l740" class="linenr"> 740</a> #ifdef&nbsp;BOOT2</div>
<div class="pre"><a id="l741" href="#l741" class="linenr"> 741</a> struct&nbsp;hfs&nbsp;hfs;</div>
<div class="pre"><a id="l742" href="#l742" class="linenr"> 742</a> </div>
<div class="pre"><a id="l743" href="#l743" class="linenr"> 743</a> static&nbsp;int</div>
<div class="pre"><a id="l744" href="#l744" class="linenr"> 744</a> hammerinit(void)</div>
<div class="pre"><a id="l745" href="#l745" class="linenr"> 745</a> {</div>
<div class="pre"><a id="l746" href="#l746" class="linenr"> 746</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(dsk_meta)</div>
<div class="pre"><a id="l747" href="#l747" class="linenr"> 747</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(0);</div>
<div class="pre"><a id="l748" href="#l748" class="linenr"> 748</a> </div>
<div class="pre"><a id="l749" href="#l749" class="linenr"> 749</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_volume_ondisk_t&nbsp;volhead&nbsp;=&nbsp;hread(&amp;hfs,&nbsp;HAMMER_ZONE_ENCODE(1,&nbsp;0));</div>
<div class="pre"><a id="l750" href="#l750" class="linenr"> 750</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(volhead&nbsp;==&nbsp;NULL)</div>
<div class="pre"><a id="l751" href="#l751" class="linenr"> 751</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(-1);</div>
<div class="pre"><a id="l752" href="#l752" class="linenr"> 752</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(volhead-&gt;vol_signature&nbsp;!=&nbsp;HAMMER_FSBUF_VOLUME)</div>
<div class="pre"><a id="l753" href="#l753" class="linenr"> 753</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(-1);</div>
<div class="pre"><a id="l754" href="#l754" class="linenr"> 754</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hfs.root&nbsp;=&nbsp;volhead-&gt;vol0_btree_root;</div>
<div class="pre"><a id="l755" href="#l755" class="linenr"> 755</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hfs.buf_beg&nbsp;=&nbsp;volhead-&gt;vol_buf_beg;</div>
<div class="pre"><a id="l756" href="#l756" class="linenr"> 756</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dsk_meta++;</div>
<div class="pre"><a id="l757" href="#l757" class="linenr"> 757</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(0);</div>
<div class="pre"><a id="l758" href="#l758" class="linenr"> 758</a> }</div>
<div class="pre"><a id="l759" href="#l759" class="linenr"> 759</a> </div>
<div class="pre"><a id="l760" href="#l760" class="linenr"> 760</a> static&nbsp;ino_t</div>
<div class="pre"><a id="l761" href="#l761" class="linenr"> 761</a> lookup(const&nbsp;char&nbsp;*path)</div>
<div class="pre"><a id="l762" href="#l762" class="linenr"> 762</a> {</div>
<div class="pre"><a id="l763" href="#l763" class="linenr"> 763</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammerinit();</div>
<div class="pre"><a id="l764" href="#l764" class="linenr"> 764</a> </div>
<div class="pre"><a id="l765" href="#l765" class="linenr"> 765</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ino_t&nbsp;ino&nbsp;=&nbsp;hlookup(&amp;hfs,&nbsp;path);</div>
<div class="pre"><a id="l766" href="#l766" class="linenr"> 766</a> </div>
<div class="pre"><a id="l767" href="#l767" class="linenr"> 767</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ino&nbsp;==&nbsp;-1)</div>
<div class="pre"><a id="l768" href="#l768" class="linenr"> 768</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ino&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l769" href="#l769" class="linenr"> 769</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(ino);</div>
<div class="pre"><a id="l770" href="#l770" class="linenr"> 770</a> }</div>
<div class="pre"><a id="l771" href="#l771" class="linenr"> 771</a> </div>
<div class="pre"><a id="l772" href="#l772" class="linenr"> 772</a> static&nbsp;ssize_t</div>
<div class="pre"><a id="l773" href="#l773" class="linenr"> 773</a> fsread(ino_t&nbsp;ino,&nbsp;void&nbsp;*buf,&nbsp;size_t&nbsp;len)</div>
<div class="pre"><a id="l774" href="#l774" class="linenr"> 774</a> {</div>
<div class="pre"><a id="l775" href="#l775" class="linenr"> 775</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammerinit();</div>
<div class="pre"><a id="l776" href="#l776" class="linenr"> 776</a> </div>
<div class="pre"><a id="l777" href="#l777" class="linenr"> 777</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssize_t&nbsp;rlen&nbsp;=&nbsp;hreadf(&amp;hfs,&nbsp;ino,&nbsp;fs_off,&nbsp;len,&nbsp;buf);</div>
<div class="pre"><a id="l778" href="#l778" class="linenr"> 778</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(rlen&nbsp;!=&nbsp;-1)</div>
<div class="pre"><a id="l779" href="#l779" class="linenr"> 779</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fs_off&nbsp;+=&nbsp;rlen;</div>
<div class="pre"><a id="l780" href="#l780" class="linenr"> 780</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(rlen);</div>
<div class="pre"><a id="l781" href="#l781" class="linenr"> 781</a> }</div>
<div class="pre"><a id="l782" href="#l782" class="linenr"> 782</a> #endif</div>
<div class="pre"><a id="l783" href="#l783" class="linenr"> 783</a> </div>
<div class="pre"><a id="l784" href="#l784" class="linenr"> 784</a> #ifndef&nbsp;BOOT2</div>
<div class="pre"><a id="l785" href="#l785" class="linenr"> 785</a> static&nbsp;int</div>
<div class="pre"><a id="l786" href="#l786" class="linenr"> 786</a> hinit(struct&nbsp;hfs&nbsp;*hfs)</div>
<div class="pre"><a id="l787" href="#l787" class="linenr"> 787</a> {</div>
<div class="pre"><a id="l788" href="#l788" class="linenr"> 788</a> #if&nbsp;DEBUG</div>
<div class="pre"><a id="l789" href="#l789" class="linenr"> 789</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;hinit\n&quot;);</div>
<div class="pre"><a id="l790" href="#l790" class="linenr"> 790</a> #endif</div>
<div class="pre"><a id="l791" href="#l791" class="linenr"> 791</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;NUMCACHE;&nbsp;i++)&nbsp;{</div>
<div class="pre"><a id="l792" href="#l792" class="linenr"> 792</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hfs-&gt;cache[i].data&nbsp;=&nbsp;malloc(HAMMER_BUFSIZE);</div>
<div class="pre"><a id="l793" href="#l793" class="linenr"> 793</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hfs-&gt;cache[i].off&nbsp;=&nbsp;-1;&nbsp;//&nbsp;invalid</div>
<div class="pre"><a id="l794" href="#l794" class="linenr"> 794</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hfs-&gt;cache[i].use&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l795" href="#l795" class="linenr"> 795</a> </div>
<div class="pre"><a id="l796" href="#l796" class="linenr"> 796</a> #if&nbsp;DEBUG</div>
<div class="pre"><a id="l797" href="#l797" class="linenr"> 797</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hfs-&gt;cache[i].data&nbsp;==&nbsp;NULL)</div>
<div class="pre"><a id="l798" href="#l798" class="linenr"> 798</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;malloc&nbsp;failed\n&quot;);</div>
<div class="pre"><a id="l799" href="#l799" class="linenr"> 799</a> #endif</div>
<div class="pre"><a id="l800" href="#l800" class="linenr"> 800</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l801" href="#l801" class="linenr"> 801</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hfs-&gt;lru&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l802" href="#l802" class="linenr"> 802</a> </div>
<div class="pre"><a id="l803" href="#l803" class="linenr"> 803</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_volume_ondisk_t&nbsp;volhead&nbsp;=&nbsp;hread(hfs,&nbsp;HAMMER_ZONE_ENCODE(1,&nbsp;0));</div>
<div class="pre"><a id="l804" href="#l804" class="linenr"> 804</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(volhead&nbsp;==&nbsp;NULL)</div>
<div class="pre"><a id="l805" href="#l805" class="linenr"> 805</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(-1);</div>
<div class="pre"><a id="l806" href="#l806" class="linenr"> 806</a> </div>
<div class="pre"><a id="l807" href="#l807" class="linenr"> 807</a> #ifdef&nbsp;TESTING</div>
<div class="pre"><a id="l808" href="#l808" class="linenr"> 808</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;signature:&nbsp;%svalid\n&quot;,</div>
<div class="pre"><a id="l809" href="#l809" class="linenr"> 809</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;volhead-&gt;vol_signature&nbsp;!=&nbsp;HAMMER_FSBUF_VOLUME&nbsp;?</div>
<div class="pre"><a id="l810" href="#l810" class="linenr"> 810</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;in&quot;&nbsp;:</div>
<div class="pre"><a id="l811" href="#l811" class="linenr"> 811</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;);</div>
<div class="pre"><a id="l812" href="#l812" class="linenr"> 812</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;name:&nbsp;%s\n&quot;,&nbsp;volhead-&gt;vol_name);</div>
<div class="pre"><a id="l813" href="#l813" class="linenr"> 813</a> #endif</div>
<div class="pre"><a id="l814" href="#l814" class="linenr"> 814</a> </div>
<div class="pre"><a id="l815" href="#l815" class="linenr"> 815</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(volhead-&gt;vol_signature&nbsp;!=&nbsp;HAMMER_FSBUF_VOLUME)&nbsp;{</div>
<div class="pre"><a id="l816" href="#l816" class="linenr"> 816</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;NUMCACHE;&nbsp;i++)</div>
<div class="pre"><a id="l817" href="#l817" class="linenr"> 817</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(hfs-&gt;cache[i].data);</div>
<div class="pre"><a id="l818" href="#l818" class="linenr"> 818</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;errno&nbsp;=&nbsp;ENODEV;</div>
<div class="pre"><a id="l819" href="#l819" class="linenr"> 819</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(-1);</div>
<div class="pre"><a id="l820" href="#l820" class="linenr"> 820</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l821" href="#l821" class="linenr"> 821</a> </div>
<div class="pre"><a id="l822" href="#l822" class="linenr"> 822</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hfs-&gt;root&nbsp;=&nbsp;volhead-&gt;vol0_btree_root;</div>
<div class="pre"><a id="l823" href="#l823" class="linenr"> 823</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hfs-&gt;buf_beg&nbsp;=&nbsp;volhead-&gt;vol_buf_beg;</div>
<div class="pre"><a id="l824" href="#l824" class="linenr"> 824</a> </div>
<div class="pre"><a id="l825" href="#l825" class="linenr"> 825</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(0);</div>
<div class="pre"><a id="l826" href="#l826" class="linenr"> 826</a> }</div>
<div class="pre"><a id="l827" href="#l827" class="linenr"> 827</a> </div>
<div class="pre"><a id="l828" href="#l828" class="linenr"> 828</a> static&nbsp;void</div>
<div class="pre"><a id="l829" href="#l829" class="linenr"> 829</a> hclose(struct&nbsp;hfs&nbsp;*hfs)</div>
<div class="pre"><a id="l830" href="#l830" class="linenr"> 830</a> {</div>
<div class="pre"><a id="l831" href="#l831" class="linenr"> 831</a> #if&nbsp;DEBUG</div>
<div class="pre"><a id="l832" href="#l832" class="linenr"> 832</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;hclose\n&quot;);</div>
<div class="pre"><a id="l833" href="#l833" class="linenr"> 833</a> #endif</div>
<div class="pre"><a id="l834" href="#l834" class="linenr"> 834</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;NUMCACHE;&nbsp;i++)</div>
<div class="pre"><a id="l835" href="#l835" class="linenr"> 835</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(hfs-&gt;cache[i].data);</div>
<div class="pre"><a id="l836" href="#l836" class="linenr"> 836</a> }</div>
<div class="pre"><a id="l837" href="#l837" class="linenr"> 837</a> #endif</div>
<div class="pre"><a id="l838" href="#l838" class="linenr"> 838</a> </div>
<div class="pre"><a id="l839" href="#l839" class="linenr"> 839</a> #ifdef&nbsp;LIBSTAND</div>
<div class="pre"><a id="l840" href="#l840" class="linenr"> 840</a> struct&nbsp;hfile&nbsp;{</div>
<div class="pre"><a id="l841" href="#l841" class="linenr"> 841</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hfs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hfs;</div>
<div class="pre"><a id="l842" href="#l842" class="linenr"> 842</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ino_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ino;</div>
<div class="pre"><a id="l843" href="#l843" class="linenr"> 843</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fsize;</div>
<div class="pre"><a id="l844" href="#l844" class="linenr"> 844</a> };</div>
<div class="pre"><a id="l845" href="#l845" class="linenr"> 845</a> </div>
<div class="pre"><a id="l846" href="#l846" class="linenr"> 846</a> static&nbsp;int</div>
<div class="pre"><a id="l847" href="#l847" class="linenr"> 847</a> hammer_open(const&nbsp;char&nbsp;*path,&nbsp;struct&nbsp;open_file&nbsp;*f)</div>
<div class="pre"><a id="l848" href="#l848" class="linenr"> 848</a> {</div>
<div class="pre"><a id="l849" href="#l849" class="linenr"> 849</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hfile&nbsp;*hf&nbsp;=&nbsp;malloc(sizeof(*hf));</div>
<div class="pre"><a id="l850" href="#l850" class="linenr"> 850</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bzero(hf,&nbsp;sizeof(*hf));</div>
<div class="pre"><a id="l851" href="#l851" class="linenr"> 851</a> </div>
<div class="pre"><a id="l852" href="#l852" class="linenr"> 852</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f-&gt;f_fsdata&nbsp;=&nbsp;hf;</div>
<div class="pre"><a id="l853" href="#l853" class="linenr"> 853</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hf-&gt;hfs.f&nbsp;=&nbsp;f;</div>
<div class="pre"><a id="l854" href="#l854" class="linenr"> 854</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f-&gt;f_offset&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l855" href="#l855" class="linenr"> 855</a> </div>
<div class="pre"><a id="l856" href="#l856" class="linenr"> 856</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;rv&nbsp;=&nbsp;hinit(&amp;hf-&gt;hfs);</div>
<div class="pre"><a id="l857" href="#l857" class="linenr"> 857</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(rv)&nbsp;{</div>
<div class="pre"><a id="l858" href="#l858" class="linenr"> 858</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(hf);</div>
<div class="pre"><a id="l859" href="#l859" class="linenr"> 859</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(rv);</div>
<div class="pre"><a id="l860" href="#l860" class="linenr"> 860</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l861" href="#l861" class="linenr"> 861</a> </div>
<div class="pre"><a id="l862" href="#l862" class="linenr"> 862</a> #if&nbsp;DEBUG</div>
<div class="pre"><a id="l863" href="#l863" class="linenr"> 863</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;hammer_open&nbsp;%s&nbsp;%p&nbsp;%ld\n&quot;,&nbsp;path,&nbsp;f);</div>
<div class="pre"><a id="l864" href="#l864" class="linenr"> 864</a> #endif</div>
<div class="pre"><a id="l865" href="#l865" class="linenr"> 865</a> </div>
<div class="pre"><a id="l866" href="#l866" class="linenr"> 866</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hf-&gt;ino&nbsp;=&nbsp;hlookup(&amp;hf-&gt;hfs,&nbsp;path);</div>
<div class="pre"><a id="l867" href="#l867" class="linenr"> 867</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hf-&gt;ino&nbsp;==&nbsp;-1)</div>
<div class="pre"><a id="l868" href="#l868" class="linenr"> 868</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;fail;</div>
<div class="pre"><a id="l869" href="#l869" class="linenr"> 869</a> </div>
<div class="pre"><a id="l870" href="#l870" class="linenr"> 870</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;stat&nbsp;st;</div>
<div class="pre"><a id="l871" href="#l871" class="linenr"> 871</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hstat(&amp;hf-&gt;hfs,&nbsp;hf-&gt;ino,&nbsp;&amp;st)&nbsp;==&nbsp;-1)</div>
<div class="pre"><a id="l872" href="#l872" class="linenr"> 872</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;fail;</div>
<div class="pre"><a id="l873" href="#l873" class="linenr"> 873</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hf-&gt;fsize&nbsp;=&nbsp;st.st_size;</div>
<div class="pre"><a id="l874" href="#l874" class="linenr"> 874</a> </div>
<div class="pre"><a id="l875" href="#l875" class="linenr"> 875</a> #if&nbsp;DEBUG</div>
<div class="pre"><a id="l876" href="#l876" class="linenr"> 876</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%ld\n&quot;,&nbsp;(long)hf-&gt;fsize);</div>
<div class="pre"><a id="l877" href="#l877" class="linenr"> 877</a> #endif</div>
<div class="pre"><a id="l878" href="#l878" class="linenr"> 878</a> </div>
<div class="pre"><a id="l879" href="#l879" class="linenr"> 879</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(0);</div>
<div class="pre"><a id="l880" href="#l880" class="linenr"> 880</a> </div>
<div class="pre"><a id="l881" href="#l881" class="linenr"> 881</a> fail:</div>
<div class="pre"><a id="l882" href="#l882" class="linenr"> 882</a> #if&nbsp;DEBUG</div>
<div class="pre"><a id="l883" href="#l883" class="linenr"> 883</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;hammer_open&nbsp;fail\n&quot;);</div>
<div class="pre"><a id="l884" href="#l884" class="linenr"> 884</a> #endif</div>
<div class="pre"><a id="l885" href="#l885" class="linenr"> 885</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hclose(&amp;hf-&gt;hfs);</div>
<div class="pre"><a id="l886" href="#l886" class="linenr"> 886</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(hf);</div>
<div class="pre"><a id="l887" href="#l887" class="linenr"> 887</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(ENOENT);</div>
<div class="pre"><a id="l888" href="#l888" class="linenr"> 888</a> }</div>
<div class="pre"><a id="l889" href="#l889" class="linenr"> 889</a> </div>
<div class="pre"><a id="l890" href="#l890" class="linenr"> 890</a> static&nbsp;int</div>
<div class="pre"><a id="l891" href="#l891" class="linenr"> 891</a> hammer_close(struct&nbsp;open_file&nbsp;*f)</div>
<div class="pre"><a id="l892" href="#l892" class="linenr"> 892</a> {</div>
<div class="pre"><a id="l893" href="#l893" class="linenr"> 893</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hfile&nbsp;*hf&nbsp;=&nbsp;f-&gt;f_fsdata;</div>
<div class="pre"><a id="l894" href="#l894" class="linenr"> 894</a> </div>
<div class="pre"><a id="l895" href="#l895" class="linenr"> 895</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hclose(&amp;hf-&gt;hfs);</div>
<div class="pre"><a id="l896" href="#l896" class="linenr"> 896</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f-&gt;f_fsdata&nbsp;=&nbsp;NULL;</div>
<div class="pre"><a id="l897" href="#l897" class="linenr"> 897</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(hf);</div>
<div class="pre"><a id="l898" href="#l898" class="linenr"> 898</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(0);</div>
<div class="pre"><a id="l899" href="#l899" class="linenr"> 899</a> }</div>
<div class="pre"><a id="l900" href="#l900" class="linenr"> 900</a> </div>
<div class="pre"><a id="l901" href="#l901" class="linenr"> 901</a> static&nbsp;int</div>
<div class="pre"><a id="l902" href="#l902" class="linenr"> 902</a> hammer_read(struct&nbsp;open_file&nbsp;*f,&nbsp;void&nbsp;*buf,&nbsp;size_t&nbsp;len,&nbsp;size_t&nbsp;*resid)</div>
<div class="pre"><a id="l903" href="#l903" class="linenr"> 903</a> {</div>
<div class="pre"><a id="l904" href="#l904" class="linenr"> 904</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hfile&nbsp;*hf&nbsp;=&nbsp;f-&gt;f_fsdata;</div>
<div class="pre"><a id="l905" href="#l905" class="linenr"> 905</a> </div>
<div class="pre"><a id="l906" href="#l906" class="linenr"> 906</a> #if&nbsp;DEBUG</div>
<div class="pre"><a id="l907" href="#l907" class="linenr"> 907</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;hammer_read&nbsp;%p&nbsp;%ld&nbsp;%ld\n&quot;,&nbsp;f,&nbsp;f-&gt;f_offset,&nbsp;len);</div>
<div class="pre"><a id="l908" href="#l908" class="linenr"> 908</a> #endif</div>
<div class="pre"><a id="l909" href="#l909" class="linenr"> 909</a> </div>
<div class="pre"><a id="l910" href="#l910" class="linenr"> 910</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(f-&gt;f_offset&nbsp;&gt;=&nbsp;hf-&gt;fsize)</div>
<div class="pre"><a id="l911" href="#l911" class="linenr"> 911</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(EINVAL);</div>
<div class="pre"><a id="l912" href="#l912" class="linenr"> 912</a> </div>
<div class="pre"><a id="l913" href="#l913" class="linenr"> 913</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;maxlen&nbsp;=&nbsp;len;</div>
<div class="pre"><a id="l914" href="#l914" class="linenr"> 914</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(f-&gt;f_offset&nbsp;+&nbsp;len&nbsp;&gt;&nbsp;hf-&gt;fsize)</div>
<div class="pre"><a id="l915" href="#l915" class="linenr"> 915</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;maxlen&nbsp;=&nbsp;hf-&gt;fsize&nbsp;-&nbsp;f-&gt;f_offset;</div>
<div class="pre"><a id="l916" href="#l916" class="linenr"> 916</a> </div>
<div class="pre"><a id="l917" href="#l917" class="linenr"> 917</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssize_t&nbsp;rlen&nbsp;=&nbsp;hreadf(&amp;hf-&gt;hfs,&nbsp;hf-&gt;ino,&nbsp;f-&gt;f_offset,&nbsp;maxlen,&nbsp;buf);</div>
<div class="pre"><a id="l918" href="#l918" class="linenr"> 918</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(rlen&nbsp;==&nbsp;-1)</div>
<div class="pre"><a id="l919" href="#l919" class="linenr"> 919</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(EINVAL);</div>
<div class="pre"><a id="l920" href="#l920" class="linenr"> 920</a> </div>
<div class="pre"><a id="l921" href="#l921" class="linenr"> 921</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f-&gt;f_offset&nbsp;+=&nbsp;rlen;</div>
<div class="pre"><a id="l922" href="#l922" class="linenr"> 922</a> </div>
<div class="pre"><a id="l923" href="#l923" class="linenr"> 923</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*resid&nbsp;=&nbsp;len&nbsp;-&nbsp;rlen;</div>
<div class="pre"><a id="l924" href="#l924" class="linenr"> 924</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(0);</div>
<div class="pre"><a id="l925" href="#l925" class="linenr"> 925</a> }</div>
<div class="pre"><a id="l926" href="#l926" class="linenr"> 926</a> </div>
<div class="pre"><a id="l927" href="#l927" class="linenr"> 927</a> static&nbsp;off_t</div>
<div class="pre"><a id="l928" href="#l928" class="linenr"> 928</a> hammer_seek(struct&nbsp;open_file&nbsp;*f,&nbsp;off_t&nbsp;offset,&nbsp;int&nbsp;whence)</div>
<div class="pre"><a id="l929" href="#l929" class="linenr"> 929</a> {</div>
<div class="pre"><a id="l930" href="#l930" class="linenr"> 930</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hfile&nbsp;*hf&nbsp;=&nbsp;f-&gt;f_fsdata;</div>
<div class="pre"><a id="l931" href="#l931" class="linenr"> 931</a> </div>
<div class="pre"><a id="l932" href="#l932" class="linenr"> 932</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(whence)&nbsp;{</div>
<div class="pre"><a id="l933" href="#l933" class="linenr"> 933</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SEEK_SET:</div>
<div class="pre"><a id="l934" href="#l934" class="linenr"> 934</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f-&gt;f_offset&nbsp;=&nbsp;offset;</div>
<div class="pre"><a id="l935" href="#l935" class="linenr"> 935</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</div>
<div class="pre"><a id="l936" href="#l936" class="linenr"> 936</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SEEK_CUR:</div>
<div class="pre"><a id="l937" href="#l937" class="linenr"> 937</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f-&gt;f_offset&nbsp;+=&nbsp;offset;</div>
<div class="pre"><a id="l938" href="#l938" class="linenr"> 938</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</div>
<div class="pre"><a id="l939" href="#l939" class="linenr"> 939</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SEEK_END:</div>
<div class="pre"><a id="l940" href="#l940" class="linenr"> 940</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f-&gt;f_offset&nbsp;=&nbsp;hf-&gt;fsize&nbsp;-&nbsp;offset;</div>
<div class="pre"><a id="l941" href="#l941" class="linenr"> 941</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</div>
<div class="pre"><a id="l942" href="#l942" class="linenr"> 942</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:</div>
<div class="pre"><a id="l943" href="#l943" class="linenr"> 943</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(-1);</div>
<div class="pre"><a id="l944" href="#l944" class="linenr"> 944</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l945" href="#l945" class="linenr"> 945</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(f-&gt;f_offset);</div>
<div class="pre"><a id="l946" href="#l946" class="linenr"> 946</a> }</div>
<div class="pre"><a id="l947" href="#l947" class="linenr"> 947</a> </div>
<div class="pre"><a id="l948" href="#l948" class="linenr"> 948</a> static&nbsp;int</div>
<div class="pre"><a id="l949" href="#l949" class="linenr"> 949</a> hammer_stat(struct&nbsp;open_file&nbsp;*f,&nbsp;struct&nbsp;stat&nbsp;*st)</div>
<div class="pre"><a id="l950" href="#l950" class="linenr"> 950</a> {</div>
<div class="pre"><a id="l951" href="#l951" class="linenr"> 951</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hfile&nbsp;*hf&nbsp;=&nbsp;f-&gt;f_fsdata;</div>
<div class="pre"><a id="l952" href="#l952" class="linenr"> 952</a> </div>
<div class="pre"><a id="l953" href="#l953" class="linenr"> 953</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(hstat(&amp;hf-&gt;hfs,&nbsp;hf-&gt;ino,&nbsp;st));</div>
<div class="pre"><a id="l954" href="#l954" class="linenr"> 954</a> }</div>
<div class="pre"><a id="l955" href="#l955" class="linenr"> 955</a> </div>
<div class="pre"><a id="l956" href="#l956" class="linenr"> 956</a> static&nbsp;int</div>
<div class="pre"><a id="l957" href="#l957" class="linenr"> 957</a> hammer_readdir(struct&nbsp;open_file&nbsp;*f,&nbsp;struct&nbsp;dirent&nbsp;*d)</div>
<div class="pre"><a id="l958" href="#l958" class="linenr"> 958</a> {</div>
<div class="pre"><a id="l959" href="#l959" class="linenr"> 959</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hfile&nbsp;*hf&nbsp;=&nbsp;f-&gt;f_fsdata;</div>
<div class="pre"><a id="l960" href="#l960" class="linenr"> 960</a> </div>
<div class="pre"><a id="l961" href="#l961" class="linenr"> 961</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;off&nbsp;=&nbsp;f-&gt;f_offset;</div>
<div class="pre"><a id="l962" href="#l962" class="linenr"> 962</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;rv&nbsp;=&nbsp;hreaddir(&amp;hf-&gt;hfs,&nbsp;hf-&gt;ino,&nbsp;&amp;off,&nbsp;d);</div>
<div class="pre"><a id="l963" href="#l963" class="linenr"> 963</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f-&gt;f_offset&nbsp;=&nbsp;off;</div>
<div class="pre"><a id="l964" href="#l964" class="linenr"> 964</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(rv);</div>
<div class="pre"><a id="l965" href="#l965" class="linenr"> 965</a> }</div>
<div class="pre"><a id="l966" href="#l966" class="linenr"> 966</a> </div>
<div class="pre"><a id="l967" href="#l967" class="linenr"> 967</a> //&nbsp;libstand</div>
<div class="pre"><a id="l968" href="#l968" class="linenr"> 968</a> struct&nbsp;fs_ops&nbsp;hammer_fsops&nbsp;=&nbsp;{</div>
<div class="pre"><a id="l969" href="#l969" class="linenr"> 969</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;hammer&quot;,</div>
<div class="pre"><a id="l970" href="#l970" class="linenr"> 970</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_open,</div>
<div class="pre"><a id="l971" href="#l971" class="linenr"> 971</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_close,</div>
<div class="pre"><a id="l972" href="#l972" class="linenr"> 972</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_read,</div>
<div class="pre"><a id="l973" href="#l973" class="linenr"> 973</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;null_write,</div>
<div class="pre"><a id="l974" href="#l974" class="linenr"> 974</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_seek,</div>
<div class="pre"><a id="l975" href="#l975" class="linenr"> 975</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_stat,</div>
<div class="pre"><a id="l976" href="#l976" class="linenr"> 976</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hammer_readdir</div>
<div class="pre"><a id="l977" href="#l977" class="linenr"> 977</a> };</div>
<div class="pre"><a id="l978" href="#l978" class="linenr"> 978</a> #endif&nbsp;&nbsp;//&nbsp;LIBSTAND</div>
<div class="pre"><a id="l979" href="#l979" class="linenr"> 979</a> </div>
<div class="pre"><a id="l980" href="#l980" class="linenr"> 980</a> #ifdef&nbsp;TESTING</div>
<div class="pre"><a id="l981" href="#l981" class="linenr"> 981</a> int</div>
<div class="pre"><a id="l982" href="#l982" class="linenr"> 982</a> main(int&nbsp;argc,&nbsp;char&nbsp;**argv)</div>
<div class="pre"><a id="l983" href="#l983" class="linenr"> 983</a> {</div>
<div class="pre"><a id="l984" href="#l984" class="linenr"> 984</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(argc&nbsp;&lt;&nbsp;2)&nbsp;{</div>
<div class="pre"><a id="l985" href="#l985" class="linenr"> 985</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(stderr,&nbsp;&quot;usage:&nbsp;hammerread&nbsp;&lt;dev&gt;\n&quot;);</div>
<div class="pre"><a id="l986" href="#l986" class="linenr"> 986</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(1);</div>
<div class="pre"><a id="l987" href="#l987" class="linenr"> 987</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l988" href="#l988" class="linenr"> 988</a> </div>
<div class="pre"><a id="l989" href="#l989" class="linenr"> 989</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;hfs&nbsp;hfs;</div>
<div class="pre"><a id="l990" href="#l990" class="linenr"> 990</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hfs.fd&nbsp;=&nbsp;open(argv[1],&nbsp;O_RDONLY);</div>
<div class="pre"><a id="l991" href="#l991" class="linenr"> 991</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hfs.fd&nbsp;==&nbsp;-1)</div>
<div class="pre"><a id="l992" href="#l992" class="linenr"> 992</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err(1,&nbsp;&quot;unable&nbsp;to&nbsp;open&nbsp;%s&quot;,&nbsp;argv[1]);</div>
<div class="pre"><a id="l993" href="#l993" class="linenr"> 993</a> </div>
<div class="pre"><a id="l994" href="#l994" class="linenr"> 994</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hinit(&amp;hfs)&nbsp;==&nbsp;-1)</div>
<div class="pre"><a id="l995" href="#l995" class="linenr"> 995</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err(1,&nbsp;&quot;invalid&nbsp;hammerfs&quot;);</div>
<div class="pre"><a id="l996" href="#l996" class="linenr"> 996</a> </div>
<div class="pre"><a id="l997" href="#l997" class="linenr"> 997</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;2;&nbsp;i&nbsp;&lt;&nbsp;argc;&nbsp;i++)&nbsp;{</div>
<div class="pre"><a id="l998" href="#l998" class="linenr"> 998</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ino_t&nbsp;ino&nbsp;=&nbsp;hlookup(&amp;hfs,&nbsp;argv[i]);</div>
<div class="pre"><a id="l999" href="#l999" class="linenr"> 999</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ino&nbsp;==&nbsp;(ino_t)-1)&nbsp;{</div>
<div class="pre"><a id="l1000" href="#l1000" class="linenr">1000</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;warn(&quot;hlookup&nbsp;%s&quot;,&nbsp;argv[i]);</div>
<div class="pre"><a id="l1001" href="#l1001" class="linenr">1001</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</div>
<div class="pre"><a id="l1002" href="#l1002" class="linenr">1002</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l1003" href="#l1003" class="linenr">1003</a> </div>
<div class="pre"><a id="l1004" href="#l1004" class="linenr">1004</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;stat&nbsp;st;</div>
<div class="pre"><a id="l1005" href="#l1005" class="linenr">1005</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hstat(&amp;hfs,&nbsp;ino,&nbsp;&amp;st))&nbsp;{</div>
<div class="pre"><a id="l1006" href="#l1006" class="linenr">1006</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;warn(&quot;hstat&nbsp;%s&quot;,&nbsp;argv[i]);</div>
<div class="pre"><a id="l1007" href="#l1007" class="linenr">1007</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</div>
<div class="pre"><a id="l1008" href="#l1008" class="linenr">1008</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l1009" href="#l1009" class="linenr">1009</a> </div>
<div class="pre"><a id="l1010" href="#l1010" class="linenr">1010</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%s&nbsp;%d/%d&nbsp;%o&nbsp;%lld\n&quot;,</div>
<div class="pre"><a id="l1011" href="#l1011" class="linenr">1011</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;argv[i],</div>
<div class="pre"><a id="l1012" href="#l1012" class="linenr">1012</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;st.st_uid,&nbsp;st.st_gid,</div>
<div class="pre"><a id="l1013" href="#l1013" class="linenr">1013</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;st.st_mode,&nbsp;st.st_size);</div>
<div class="pre"><a id="l1014" href="#l1014" class="linenr">1014</a> </div>
<div class="pre"><a id="l1015" href="#l1015" class="linenr">1015</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(S_ISDIR(st.st_mode))&nbsp;{</div>
<div class="pre"><a id="l1016" href="#l1016" class="linenr">1016</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;off&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l1017" href="#l1017" class="linenr">1017</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;dirent&nbsp;de;</div>
<div class="pre"><a id="l1018" href="#l1018" class="linenr">1018</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(hreaddir(&amp;hfs,&nbsp;ino,&nbsp;&amp;off,&nbsp;&amp;de)&nbsp;==&nbsp;0)&nbsp;{</div>
<div class="pre"><a id="l1019" href="#l1019" class="linenr">1019</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%s&nbsp;%d&nbsp;%llx\n&quot;,</div>
<div class="pre"><a id="l1020" href="#l1020" class="linenr">1020</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;de.d_name,&nbsp;de.d_type,&nbsp;de.d_ino);</div>
<div class="pre"><a id="l1021" href="#l1021" class="linenr">1021</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l1022" href="#l1022" class="linenr">1022</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(S_ISREG(st.st_mode))&nbsp;{</div>
<div class="pre"><a id="l1023" href="#l1023" class="linenr">1023</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;*buf&nbsp;=&nbsp;malloc(100000);</div>
<div class="pre"><a id="l1024" href="#l1024" class="linenr">1024</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;off&nbsp;=&nbsp;0;</div>
<div class="pre"><a id="l1025" href="#l1025" class="linenr">1025</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(off&nbsp;&lt;&nbsp;st.st_size)&nbsp;{</div>
<div class="pre"><a id="l1026" href="#l1026" class="linenr">1026</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;len&nbsp;=&nbsp;MIN(100000,&nbsp;st.st_size&nbsp;-&nbsp;off);</div>
<div class="pre"><a id="l1027" href="#l1027" class="linenr">1027</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;rl&nbsp;=&nbsp;hreadf(&amp;hfs,&nbsp;ino,&nbsp;off,&nbsp;len,&nbsp;buf);</div>
<div class="pre"><a id="l1028" href="#l1028" class="linenr">1028</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fwrite(buf,&nbsp;rl,&nbsp;1,&nbsp;stdout);</div>
<div class="pre"><a id="l1029" href="#l1029" class="linenr">1029</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;off&nbsp;+=&nbsp;rl;</div>
<div class="pre"><a id="l1030" href="#l1030" class="linenr">1030</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l1031" href="#l1031" class="linenr">1031</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(buf);</div>
<div class="pre"><a id="l1032" href="#l1032" class="linenr">1032</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l1033" href="#l1033" class="linenr">1033</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div>
<div class="pre"><a id="l1034" href="#l1034" class="linenr">1034</a> </div>
<div class="pre"><a id="l1035" href="#l1035" class="linenr">1035</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;</div>
<div class="pre"><a id="l1036" href="#l1036" class="linenr">1036</a> }</div>
<div class="pre"><a id="l1037" href="#l1037" class="linenr">1037</a> #endif</div>
</div><div class="page_footer">
<div class="page_footer_text">DragonFly BSD source repository</div>
<a class="rss_logo" title="history of lib/libstand/hammerread.c RSS feed" href="/dragonfly.git/rss?f=lib/libstand/hammerread.c">RSS</a>
<a class="rss_logo" title="history of lib/libstand/hammerread.c Atom feed" href="/dragonfly.git/atom?f=lib/libstand/hammerread.c">Atom</a>
</div>
</body>
</html>